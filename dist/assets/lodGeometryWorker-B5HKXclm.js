(function(){"use strict";function ce(){return{grassPositions:[],grassNormals:[],grassUvs:[],grassSkyLight:[],grassIndices:[],grassVertexOffset:0,dirtPositions:[],dirtNormals:[],dirtUvs:[],dirtSkyLight:[],dirtIndices:[],dirtVertexOffset:0,stonePositions:[],stoneNormals:[],stoneUvs:[],stoneSkyLight:[],stoneIndices:[],stoneVertexOffset:0,sandPositions:[],sandNormals:[],sandUvs:[],sandSkyLight:[],sandIndices:[],sandVertexOffset:0,woodPositions:[],woodNormals:[],woodUvs:[],woodSkyLight:[],woodIndices:[],woodVertexOffset:0,waterPositions:[],waterNormals:[],waterUvs:[],waterIndices:[],waterVertexOffset:0,sidePositions:[],sideNormals:[],sideUvs:[],sideSkyLight:[],sideIndices:[],sideVertexOffset:0,waterSidePositions:[],waterSideNormals:[],waterSideUvs:[],waterSideIndices:[],waterSideVertexOffset:0}}const S={AIR:0,STONE:1,DIRT:2,GRASS:3,WATER:4,SAND:5,WOOD:6};function $(Z,H){return H.radius-(H.maxDepth-1-Z)*H.blockHeight}function de(Z){return Z.maxDepth-1-Z.seaLevel}let Y=null,te=0;self.onmessage=Z=>{const{type:H,tileData:se,blockData:ae,nearbyTiles:fe,tileToChunk:le,config:E}=Z.data;if(H==="buildLODGeometry"){const Q=new Set(fe),ee=new Map(Object.entries(le).map(([d,V])=>[parseInt(d),V])),G=new Map;for(const[d,V]of Object.entries(se)){const s=parseInt(d),n=ae[s];n&&G.set(s,{tileIndex:s,tile:V,blocks:n})}const ne=Object.keys(se).length;if(!Y||te!==ne){Y=new Map,te=ne;for(const[d,V]of G){const s=V.tile,n=s.vertices.length,r=Math.sqrt(s.center.x*s.center.x+s.center.y*s.center.y+s.center.z*s.center.z),c=r>0?{x:s.center.x/r,y:s.center.y/r,z:s.center.z/r}:{x:0,y:0,z:0},e=[];for(const i of s.vertices){const z=Math.sqrt(i.x*i.x+i.y*i.y+i.z*i.z);e.push(z>0?{x:i.x/z,y:i.y/z,z:i.z/z}:{x:0,y:0,z:0})}const a=[];for(let i=0;i<n;i++){const z=(i+1)%n,O=s.vertices[i],k=s.vertices[z],I=O.x+k.x,w=O.y+k.y,y=O.z+k.z,p=Math.sqrt(I*I+w*w+y*y);a.push(p>0?{x:I/p,y:w/p,z:y/p}:{x:0,y:0,z:0})}const h=[];for(let i=0;i<n;i++){const z=a[i];let O=-1,k=1/0;for(const I of s.neighbors){const w=G.get(I);if(!w)continue;const y=w.tile.center,p=Math.sqrt(y.x*y.x+y.y*y.y+y.z*y.z);if(p===0)continue;const C=y.x/p,R=y.y/p,L=y.z/p,T=C-z.x,D=R-z.y,b=L-z.z,_=T*T+D*D+b*b;_<k&&(k=_,O=I)}h.push(O)}const t=Math.abs(c.y)<.9?{x:0,y:1,z:0}:{x:1,y:0,z:0},l=t.y*c.z-t.z*c.y,x=t.z*c.x-t.x*c.z,o=t.x*c.y-t.y*c.x,f=Math.sqrt(l*l+x*x+o*o),u=f>0?{x:l/f,y:x/f,z:o/f}:{x:1,y:0,z:0},m=c.y*u.z-c.z*u.y,v=c.z*u.x-c.x*u.z,N=c.x*u.y-c.y*u.x,g={x:m,y:v,z:N},U=[];let M=1/0,A=-1/0,P=1/0,W=-1/0;for(const i of s.vertices){const z=i.x-s.center.x,O=i.y-s.center.y,k=i.z-s.center.z,I=z*u.x+O*u.y+k*u.z,w=z*g.x+O*g.y+k*g.z;U.push({u:I,v:w}),M=Math.min(M,I),A=Math.max(A,I),P=Math.min(P,w),W=Math.max(W,w)}const q=A-M,X=W-P,J=U.map(i=>({u:(i.u-M)/q,v:(i.v-P)/X})),K={u:(0-M)/q,v:(0-P)/X};Y.set(d,{normalizedCenter:c,normalizedVertices:e,edgeMidDirs:a,edgeNeighborIdx:h,normalizedUVs:J,centerUV:K})}}const F=[];for(let d=0;d<E.chunkCount;d++)F.push(ce());const xe=de(E),oe=$(xe,E)-E.lodOffset,B=new Map;for(const[d,V]of G){let s=0,n=S.GRASS,r=0;const c=V.blocks;for(let t=c.length-1;t>=0;t--)if(c[t]!==S.AIR&&(n===S.GRASS&&(s=t,n=c[t]),c[t]!==S.WATER)){r=t;break}const e=n===S.WATER,a=e?oe:$(s,E)-E.lodOffset,h=$(r,E)-E.lodOffset;B.set(d,{radius:a,isWater:e,surfaceBlockType:n,terrainRadius:h})}for(const[d]of G){if(Q.has(d))continue;const V=Y.get(d),s=B.get(d),n=s.radius,r=s.surfaceBlockType,c=ee.get(d)??0,e=F[c];let a,h,t,l,x,o;r===S.WATER?(a=e.waterPositions,h=e.waterNormals,t=e.waterUvs,l=null,x=e.waterIndices,o=e.waterVertexOffset):r===S.DIRT?(a=e.dirtPositions,h=e.dirtNormals,t=e.dirtUvs,l=e.dirtSkyLight,x=e.dirtIndices,o=e.dirtVertexOffset):r===S.STONE?(a=e.stonePositions,h=e.stoneNormals,t=e.stoneUvs,l=e.stoneSkyLight,x=e.stoneIndices,o=e.stoneVertexOffset):r===S.SAND?(a=e.sandPositions,h=e.sandNormals,t=e.sandUvs,l=e.sandSkyLight,x=e.sandIndices,o=e.sandVertexOffset):r===S.WOOD?(a=e.woodPositions,h=e.woodNormals,t=e.woodUvs,l=e.woodSkyLight,x=e.woodIndices,o=e.woodVertexOffset):(a=e.grassPositions,h=e.grassNormals,t=e.grassUvs,l=e.grassSkyLight,x=e.grassIndices,o=e.grassVertexOffset);const f=V.normalizedCenter,u=V.normalizedVertices,m=V.normalizedUVs,v=V.centerUV,N=o;a.push(f.x*n,f.y*n,f.z*n),h.push(f.x,f.y,f.z),t.push(v.u,v.v),l&&l.push(1),o++;for(let g=0;g<u.length;g++){const U=u[g];a.push(U.x*n,U.y*n,U.z*n),h.push(f.x,f.y,f.z),t.push(m[g].u,m[g].v),l&&l.push(1),o++,x.push(N,N+1+g,N+1+(g+1)%u.length)}r===S.WATER?e.waterVertexOffset=o:r===S.DIRT?e.dirtVertexOffset=o:r===S.STONE?e.stoneVertexOffset=o:r===S.SAND?e.sandVertexOffset=o:r===S.WOOD?e.woodVertexOffset=o:e.grassVertexOffset=o}for(const[d]of G){if(Q.has(d))continue;const V=Y.get(d),s=B.get(d),n=s.radius,r=s.isWater,c=V.normalizedVertices,e=V.edgeNeighborIdx,a=c.length,h=ee.get(d)??0,t=F[h];for(let l=0;l<a;l++){const x=e[l];if(x<0)continue;const o=B.get(x);if(!o)continue;const f=o.radius;if(n<=f)continue;const u=(l+1)%a,m=c[l],v=c[u],N=m.x*f,g=m.y*f,U=m.z*f,M=v.x*f,A=v.y*f,P=v.z*f,W=m.x*n,q=m.y*n,X=m.z*n,J=v.x*n,K=v.y*n,i=v.z*n,z=M-N,O=A-g,k=P-U,I=W-N,w=q-g,y=X-U,p=O*y-k*w,C=k*I-z*y,R=z*w-O*I,L=Math.sqrt(p*p+C*C+R*R),T=L>0?p/L:0,D=L>0?C/L:0,b=L>0?R/L:0,_=r?t.waterSidePositions:t.sidePositions,he=r?t.waterSideNormals:t.sideNormals,ye=r?t.waterSideUvs:t.sideUvs,ie=r?null:t.sideSkyLight,re=r?t.waterSideIndices:t.sideIndices,j=r?t.waterSideVertexOffset:t.sideVertexOffset;_.push(N,g,U,M,A,P,J,K,i,W,q,X),he.push(T,D,b,T,D,b,T,D,b,T,D,b),ye.push(0,0,1,0,1,1,0,1),ie&&ie.push(1,1,1,1),re.push(j,j+1,j+2),re.push(j,j+2,j+3),r?t.waterSideVertexOffset+=4:t.sideVertexOffset+=4}}for(const[d]of G){if(Q.has(d))continue;const V=Y.get(d),s=B.get(d);if(!s||!s.isWater)continue;const n=V.normalizedVertices,r=V.edgeNeighborIdx,c=n.length,e=ee.get(d)??0,a=F[e];for(let h=0;h<c;h++){const t=r[h];if(t<0||!Q.has(t))continue;const l=B.get(t);if(!l)continue;const x=l.terrainRadius,o=oe;if(x>=o)continue;const f=(h+1)%c,u=n[h],m=n[f],v=u.x*x,N=u.y*x,g=u.z*x,U=m.x*x,M=m.y*x,A=m.z*x,P=u.x*o,W=u.y*o,q=u.z*o,X=m.x*o,J=m.y*o,K=m.z*o,i=U-v,z=M-N,O=A-g,k=P-v,I=W-N,w=q-g,y=z*w-O*I,p=O*k-i*w,C=i*I-z*k,R=Math.sqrt(y*y+p*p+C*C),L=R>0?y/R:0,T=R>0?p/R:0,D=R>0?C/R:0,b=a.waterSideVertexOffset;a.waterSidePositions.push(v,N,g,U,M,A,X,J,K,P,W,q),a.waterSideNormals.push(L,T,D,L,T,D,L,T,D,L,T,D),a.waterSideUvs.push(0,0,1,0,1,1,0,1),a.waterSideIndices.push(b,b+1,b+2),a.waterSideIndices.push(b,b+2,b+3),a.waterSideVertexOffset+=4}}const ue={type:"lodGeometryResult",chunkGeometries:F};self.postMessage(ue)}}})();
//# sourceMappingURL=lodGeometryWorker-B5HKXclm.js.map
