(function(){"use strict";var s=(t=>(t[t.AIR=0]="AIR",t[t.STONE=1]="STONE",t[t.DIRT=2]="DIRT",t[t.GRASS=3]="GRASS",t[t.WATER=4]="WATER",t[t.SAND=5]="SAND",t[t.WOOD=6]="WOOD",t[t.LEAVES=7]="LEAVES",t[t.ORE_COAL=8]="ORE_COAL",t[t.ORE_COPPER=9]="ORE_COPPER",t[t.ORE_IRON=10]="ORE_IRON",t[t.ORE_GOLD=11]="ORE_GOLD",t[t.ORE_LITHIUM=12]="ORE_LITHIUM",t[t.ORE_ALUMINUM=13]="ORE_ALUMINUM",t[t.ORE_COBALT=14]="ORE_COBALT",t[t.SNOW=15]="SNOW",t[t.DIRT_SNOW=16]="DIRT_SNOW",t[t.ICE=17]="ICE",t[t.FURNACE=18]="FURNACE",t[t.GLASS=19]="GLASS",t[t.COMPUTER=20]="COMPUTER",t[t.PRINTER_3D=21]="PRINTER_3D",t[t.MOON_ROCK=22]="MOON_ROCK",t))(s||{});function J(t,o,r){return{x:t,y:o,z:r}}function Q(t){return{x:t.x,y:t.y,z:t.z}}function V(t,o){return{x:t.x-o.x,y:t.y-o.y,z:t.z-o.z}}function x(t,o){return{x:t.x*o,y:t.y*o,z:t.z*o}}function et(t,o){return t.x*o.x+t.y*o.y+t.z*o.z}function Y(t,o){return{x:t.y*o.z-t.z*o.y,y:t.z*o.x-t.x*o.z,z:t.x*o.y-t.y*o.x}}function X(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}function k(t){const o=X(t);return o===0?{x:0,y:0,z:0}:{x:t.x/o,y:t.y/o,z:t.z/o}}function at(t){return{x:-t.x,y:-t.y,z:-t.z}}function H(t,o){return X(V(t,o))}const B=.8,tt=.05;function st(t,o,r,g,R,u,b){if(r[R]!==s.WATER)return;const O=t.length,f=.001;for(let p=0;p<O;p++){const c=(p+1)%O,m=t[p],a=t[c];let C;for(const S of o){const y=g.get(S);if(!y)continue;let F=!1,j=!1;for(const K of y.vertices)H(K,m)<f&&(F=!0),H(K,a)<f&&(j=!0);if(F&&j){C=y;break}}if(!C||C.blocks[R]!==s.AIR)continue;const N=(R<r.length-1?r[R+1]:s.AIR)!==s.WATER,v=u.radius-(u.maxDepth-1-R)*u.blockHeight,M=N?v-u.waterSurfaceOffset:v,G=u.radius-(u.maxDepth-R)*u.blockHeight;if(G>=M)continue;const _=k(m),l=k(a),I=x(_,M),h=x(l,M),D=x(_,G),i=x(l,G),E=V(i,D),A=V(I,D),W=k(Y(E,A)),L=b.vertexOffset;b.positions.push(D.x,D.y,D.z,i.x,i.y,i.z,h.x,h.y,h.z,I.x,I.y,I.z);for(let S=0;S<4;S++)b.normals.push(W.x,W.y,W.z);b.uvs.push(0,0,1,0,1,1,0,1),b.skyLight.push(1,1,1,1),b.colors.push(1,1,1,1,1,1,1,1,1,1,1,1),b.indices.push(L,L+1,L+2,L,L+2,L+3),b.vertexOffset+=4}}function n(){return{positions:[],normals:[],uvs:[],colors:[],skyLight:[],torchLight:[],indices:[],vertexOffset:0}}function rt(t,o){return o.radius-(o.maxDepth-1-t)*o.blockHeight}function it(t,o,r,g){let R=0;for(const u of g){const b=t-u.position.x,O=o-u.position.y,f=r-u.position.z,p=Math.sqrt(b*b+O*O+f*f);if(p<u.range){const c=1/(1+2*p*p/(u.range*u.range));R+=c*u.intensity}}return Math.min(R,1.5)}function ct(){return{topData:n(),sideData:n(),grassSideData:n(),stoneData:n(),sandData:n(),woodData:n(),waterData:n(),oreCoalData:n(),oreCopperData:n(),oreIronData:n(),oreGoldData:n(),oreLithiumData:n(),oreAluminumData:n(),oreCobaltData:n(),snowData:n(),snowSideData:n(),dirtSnowData:n(),iceData:n(),glassData:n(),moonRockData:n()}}function ut(t){return t===s.AIR||t===s.WATER||t===s.ICE||t===s.GLASS}function lt(t,o,r){const g=t.blocks[o];if(g===s.AIR||g===s.WATER)return!1;for(const R of t.tile.neighbors){const u=r.get(R);if(!u)return!0;const b=u.blocks[o];if(b===void 0||ut(b))return!0}return!1}function w(t,o,r,g,R,u,b,O=[]){const f=o.length/3,p=t.vertexOffset;t.positions.push.apply(t.positions,o),t.normals.push.apply(t.normals,r),t.uvs.push.apply(t.uvs,g);const c=new Array(f*3);for(let d=0;d<f;d++){const N=d*3;c[N]=1,c[N+1]=1,c[N+2]=1}t.colors.push.apply(t.colors,c);const m=new Array(f);for(let d=0;d<f;d++)m[d]=b;t.skyLight.push.apply(t.skyLight,m);const a=new Array(f);for(let d=0;d<f;d++){const N=o[d*3],v=o[d*3+1],M=o[d*3+2];a[d]=it(N,v,M,O)}t.torchLight.push.apply(t.torchLight,a);const C=new Array(R.length);for(let d=0;d<R.length;d++)C[d]=R[d]+p;t.indices.push.apply(t.indices,C),t.vertexOffset+=f}function Z(t,o,r,g,R,u,b=10){const O=t.vertices.length,f=k(t.center),p=[],c=[];for(const l of t.vertices){const I=k(l);p.push(x(I,o)),c.push(x(I,r))}const m=x(f,o),a=x(f,r),C=Q(f);let d=J(1,0,0);Math.abs(et(C,d))>.9&&(d=J(0,0,1));const N=k(Y(C,d));d=k(Y(N,C));const v=[],M=[],G=[],_=[];if(g){const l=Q(f);v.push(a.x,a.y,a.z),M.push(l.x,l.y,l.z),G.push(.5,.5);const I=.5;for(let h=0;h<O;h++){const D=c[h];v.push(D.x,D.y,D.z),M.push(l.x,l.y,l.z);const i=h/O*Math.PI*2-Math.PI/2,E=.5+Math.cos(i)*I,A=.5+Math.sin(i)*I;G.push(E,A)}for(let h=0;h<O;h++){const D=(h+1)%O;_.push(0,1+h,1+D)}}else if(R){const l=at(f);v.push(m.x,m.y,m.z),M.push(l.x,l.y,l.z),G.push(.5,.5);const I=.5;for(let h=0;h<O;h++){const D=p[h];v.push(D.x,D.y,D.z),M.push(l.x,l.y,l.z);const i=h/O*Math.PI*2-Math.PI/2,E=.5+Math.cos(i)*I,A=.5+Math.sin(i)*I;G.push(E,A)}for(let h=0;h<O;h++){const D=(h+1)%O;_.push(0,1+D,1+h)}}else if(u){let l=0;for(let I=0;I<O;I++){const h=(I+1)%O,D=c[I],i=c[h],E=p[I],A=p[h],W=V(A,E),L=V(D,E),S=k(Y(W,L));v.push(E.x,E.y,E.z,A.x,A.y,A.z,i.x,i.y,i.z,D.x,D.y,D.z);for(let y=0;y<4;y++)M.push(S.x,S.y,S.z);G.push(0,0,1,0,1,1,0,1),_.push(l,l+1,l+2,l,l+2,l+3),l+=4}}return v.length===0?null:{positions:v,normals:M,uvs:G,indices:_}}function ot(t,o,r,g,R,u,b,O,f,p,c,m,a,C,d,N,v,M,G,_,l,I,h){let D=0;for(let i=t.blocks.length-1;i>=0;i--)if(t.blocks[i]!==s.AIR&&t.blocks[i]!==s.WATER){D=i;break}for(let i=0;i<t.blocks.length;i++){const E=t.blocks[i];if(E===s.AIR)continue;const A=E===s.WATER,W=E===s.ICE,L=E===s.GLASS,S=i>=t.blocks.length-1?s.AIR:t.blocks[i+1],y=i===0?s.AIR:t.blocks[i-1],F=S===s.AIR||!A&&S===s.WATER||!W&&!L&&(S===s.ICE||S===s.GLASS),j=y===s.AIR||!A&&y===s.WATER||!W&&!L&&(y===s.ICE||y===s.GLASS);if(A&&S!==s.AIR&&S!==s.ICE&&S!==s.GLASS)continue;const K=!A&&lt(t,i,o);if(!A&&!F&&!j&&!K)continue;let T=rt(i,r),q=T-r.blockHeight;if(A&&(T-=r.waterSurfaceOffset,q-=r.waterSurfaceOffset),q<=0)continue;const nt=D-i;let z;switch(E){case s.ORE_COAL:z=c;break;case s.ORE_COPPER:z=m;break;case s.ORE_IRON:z=a;break;case s.ORE_GOLD:z=C;break;case s.ORE_LITHIUM:z=d;break;case s.ORE_ALUMINUM:z=N;break;case s.ORE_COBALT:z=v;break;case s.STONE:z=b;break;case s.SAND:z=O;break;case s.DIRT:z=R;break;case s.WOOD:z=f;break;case s.SNOW:z=M;break;case s.DIRT_SNOW:z=_;break;case s.ICE:z=l;break;case s.GLASS:z=I;break;case s.MOON_ROCK:z=h;break;default:z=g;break}let U=1;nt>0&&(U=Math.max(tt,Math.pow(B,nt)));const P=r.torches||[];if(A||F){const e=Z(t.tile,q,T,!0,!1,!1,r.uvScale);e&&(A?w(p,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,1,P):w(z,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,U,P))}if(!A&&j){const e=Z(t.tile,q,T,!1,!0,!1,r.uvScale);if(e){const $=Math.max(tt,U*B);E===s.GRASS?w(R,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,$,P):E===s.SNOW?w(_,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,$,P):w(z,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,$,P)}}if(!A&&K){const e=Z(t.tile,q,T,!1,!1,!0,r.uvScale);e&&(E===s.GRASS?w(u,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,U,P):E===s.SNOW?w(G,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,U,P):w(z,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,U,P))}}}self.onmessage=t=>{const{type:o,columns:r,neighborData:g,config:R}=t.data;if(o==="buildGeometry"){const u=n(),b=n(),O=n(),f=n(),p=n(),c=n(),m=n(),a=n(),C=n(),d=n(),N=n(),v=n(),M=n(),G=n(),_=n(),l=n(),I=n(),h=n(),D=n(),i=n(),E=new Map(Object.entries(g).map(([L,S])=>[parseInt(L),S]));for(const L of r){ot(L,E,R,u,b,O,f,p,c,m,a,C,d,N,v,M,G,_,l,I,h,D,i);for(let S=0;S<L.blocks.length;S++)L.blocks[S]===s.WATER&&st(L.tile.vertices,L.tile.neighbors,L.blocks,E,S,R,m)}let A=0;for(const L of[u,b,O,f,p,c])A+=L.torchLight.filter(S=>S>0).length;(A>0||R.torches&&R.torches.length>0)&&console.log(`[GeometryWorker] Total non-zero torchLight values: ${A}`);const W={type:"geometryResult",topData:u,sideData:b,grassSideData:O,stoneData:f,sandData:p,woodData:c,waterData:m,oreCoalData:a,oreCopperData:C,oreIronData:d,oreGoldData:N,oreLithiumData:v,oreAluminumData:M,oreCobaltData:G,snowData:_,snowSideData:l,dirtSnowData:I,iceData:h,glassData:D,moonRockData:i};self.postMessage(W)}else if(o==="buildChunkGeometry"){const u=t.data,b=new Map(Object.entries(u.tileToChunk).map(([c,m])=>[parseInt(c),m])),O=new Map(Object.entries(g).map(([c,m])=>[parseInt(c),m])),f={};for(const c of u.chunksToRebuild)f[c]=ct();for(const c of r){const m=b.get(c.tileIndex);if(m===void 0||!f[m])continue;const a=f[m];ot(c,O,R,a.topData,a.sideData,a.grassSideData,a.stoneData,a.sandData,a.woodData,a.waterData,a.oreCoalData,a.oreCopperData,a.oreIronData,a.oreGoldData,a.oreLithiumData,a.oreAluminumData,a.oreCobaltData,a.snowData,a.snowSideData,a.dirtSnowData,a.iceData,a.glassData,a.moonRockData);for(let C=0;C<c.blocks.length;C++)c.blocks[C]===s.WATER&&st(c.tile.vertices,c.tile.neighbors,c.blocks,O,C,R,a.waterData)}const p={type:"chunkGeometryResult",chunkGeometries:f,chunksRebuilt:u.chunksToRebuild};self.postMessage(p)}}})();
//# sourceMappingURL=geometryWorker-BWnecz8d.js.map
