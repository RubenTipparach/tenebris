(function(){"use strict";var n=(t=>(t[t.AIR=0]="AIR",t[t.STONE=1]="STONE",t[t.DIRT=2]="DIRT",t[t.GRASS=3]="GRASS",t[t.WATER=4]="WATER",t[t.SAND=5]="SAND",t[t.WOOD=6]="WOOD",t[t.LEAVES=7]="LEAVES",t[t.ORE_COAL=8]="ORE_COAL",t[t.ORE_COPPER=9]="ORE_COPPER",t[t.ORE_IRON=10]="ORE_IRON",t[t.ORE_GOLD=11]="ORE_GOLD",t[t.ORE_LITHIUM=12]="ORE_LITHIUM",t[t.ORE_ALUMINUM=13]="ORE_ALUMINUM",t[t.ORE_COBALT=14]="ORE_COBALT",t[t.SNOW=15]="SNOW",t[t.DIRT_SNOW=16]="DIRT_SNOW",t[t.ICE=17]="ICE",t[t.FURNACE=18]="FURNACE",t))(n||{});function Z(t,s,i){return{x:t,y:s,z:i}}function $(t){return{x:t.x,y:t.y,z:t.z}}function j(t,s){return{x:t.x-s.x,y:t.y-s.y,z:t.z-s.z}}function G(t,s){return{x:t.x*s,y:t.y*s,z:t.z*s}}function B(t,s){return t.x*s.x+t.y*s.y+t.z*s.z}function q(t,s){return{x:t.y*s.z-t.z*s.y,y:t.z*s.x-t.x*s.z,z:t.x*s.y-t.y*s.x}}function J(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}function V(t){const s=J(t);return s===0?{x:0,y:0,z:0}:{x:t.x/s,y:t.y/s,z:t.z/s}}function tt(t){return{x:-t.x,y:-t.y,z:-t.z}}function Q(t,s){return J(j(t,s))}const X=.8,H=.05;function st(t,s,i,x,f,h,b){if(i[f]!==n.WATER)return;const O=t.length,d=.001;for(let A=0;A<O;A++){const E=(A+1)%O,v=t[A],C=t[E];let L;for(const g of s){const W=x.get(g);if(!W)continue;let U=!1,P=!1;for(const T of W.vertices)Q(T,v)<d&&(U=!0),Q(T,C)<d&&(P=!0);if(U&&P){L=W;break}}if(!L||L.blocks[f]!==n.AIR)continue;const N=(f<i.length-1?i[f+1]:n.AIR)!==n.WATER,z=h.radius-(h.maxDepth-1-f)*h.blockHeight,S=N?z-h.waterSurfaceOffset:z,y=h.radius-(h.maxDepth-f)*h.blockHeight;if(y>=S)continue;const _=V(v),c=V(C),R=G(_,S),o=G(c,S),r=G(_,y),u=G(c,y),m=j(u,r),l=j(R,r),p=V(q(m,l)),M=b.vertexOffset;b.positions.push(r.x,r.y,r.z,u.x,u.y,u.z,o.x,o.y,o.z,R.x,R.y,R.z);for(let g=0;g<4;g++)b.normals.push(p.x,p.y,p.z);b.uvs.push(0,0,1,0,1,1,0,1),b.skyLight.push(1,1,1,1),b.colors.push(1,1,1,1,1,1,1,1,1,1,1,1),b.indices.push(M,M+1,M+2,M,M+2,M+3),b.vertexOffset+=4}}function I(){return{positions:[],normals:[],uvs:[],colors:[],skyLight:[],torchLight:[],indices:[],vertexOffset:0}}function ot(t,s){return s.radius-(s.maxDepth-1-t)*s.blockHeight}function nt(t,s,i,x){let f=0;for(const h of x){const b=t-h.position.x,O=s-h.position.y,d=i-h.position.z,A=Math.sqrt(b*b+O*O+d*d);if(A<h.range){const E=1/(1+2*A*A/(h.range*h.range));f+=E*h.intensity}}return Math.min(f,1.5)}function et(t){return t===n.AIR||t===n.WATER||t===n.ICE}function rt(t,s,i){const x=t.blocks[s];if(x===n.AIR||x===n.WATER)return!1;for(const f of t.tile.neighbors){const h=i.get(f);if(!h)return!0;const b=h.blocks[s];if(b===void 0||et(b))return!0}return!1}function k(t,s,i,x,f,h,b,O=[]){const d=s.length/3,A=t.vertexOffset;t.positions.push.apply(t.positions,s),t.normals.push.apply(t.normals,i),t.uvs.push.apply(t.uvs,x);const E=new Array(d*3);for(let a=0;a<d;a++){const N=a*3;E[N]=1,E[N+1]=1,E[N+2]=1}t.colors.push.apply(t.colors,E);const v=new Array(d);for(let a=0;a<d;a++)v[a]=b;t.skyLight.push.apply(t.skyLight,v);const C=new Array(d);for(let a=0;a<d;a++){const N=s[a*3],z=s[a*3+1],S=s[a*3+2];C[a]=nt(N,z,S,O)}t.torchLight.push.apply(t.torchLight,C);const L=new Array(f.length);for(let a=0;a<f.length;a++)L[a]=f[a]+A;t.indices.push.apply(t.indices,L),t.vertexOffset+=d}function K(t,s,i,x,f,h,b=10){const O=t.vertices.length,d=V(t.center),A=[],E=[];for(const c of t.vertices){const R=V(c);A.push(G(R,s)),E.push(G(R,i))}const v=G(d,s),C=G(d,i),L=$(d);let a=Z(1,0,0);Math.abs(B(L,a))>.9&&(a=Z(0,0,1));const N=V(q(L,a));a=V(q(N,L));const z=[],S=[],y=[],_=[];if(x){const c=$(d);z.push(C.x,C.y,C.z),S.push(c.x,c.y,c.z),y.push(.5,.5);const R=.5;for(let o=0;o<O;o++){const r=E[o];z.push(r.x,r.y,r.z),S.push(c.x,c.y,c.z);const u=o/O*Math.PI*2-Math.PI/2,m=.5+Math.cos(u)*R,l=.5+Math.sin(u)*R;y.push(m,l)}for(let o=0;o<O;o++){const r=(o+1)%O;_.push(0,1+o,1+r)}}else if(f){const c=tt(d);z.push(v.x,v.y,v.z),S.push(c.x,c.y,c.z),y.push(.5,.5);const R=.5;for(let o=0;o<O;o++){const r=A[o];z.push(r.x,r.y,r.z),S.push(c.x,c.y,c.z);const u=o/O*Math.PI*2-Math.PI/2,m=.5+Math.cos(u)*R,l=.5+Math.sin(u)*R;y.push(m,l)}for(let o=0;o<O;o++){const r=(o+1)%O;_.push(0,1+r,1+o)}}else if(h){let c=0;for(let R=0;R<O;R++){const o=(R+1)%O,r=E[R],u=E[o],m=A[R],l=A[o],p=j(l,m),M=j(r,m),g=V(q(p,M));z.push(m.x,m.y,m.z,l.x,l.y,l.z,u.x,u.y,u.z,r.x,r.y,r.z);for(let W=0;W<4;W++)S.push(g.x,g.y,g.z);y.push(0,0,1,0,1,1,0,1),_.push(c,c+1,c+2,c,c+2,c+3),c+=4}}return z.length===0?null:{positions:z,normals:S,uvs:y,indices:_}}function it(t,s,i,x,f,h,b,O,d,A,E,v,C,L,a,N,z,S,y,_,c){let R=0;for(let o=t.blocks.length-1;o>=0;o--)if(t.blocks[o]!==n.AIR&&t.blocks[o]!==n.WATER){R=o;break}for(let o=0;o<t.blocks.length;o++){const r=t.blocks[o];if(r===n.AIR)continue;const u=r===n.WATER,m=r===n.ICE,l=o>=t.blocks.length-1?n.AIR:t.blocks[o+1],p=o===0?n.AIR:t.blocks[o-1],M=l===n.AIR||!u&&l===n.WATER||!m&&l===n.ICE,g=p===n.AIR||!u&&p===n.WATER||!m&&p===n.ICE;if(u&&l!==n.AIR&&l!==n.ICE)continue;const W=!u&&rt(t,o,s);if(!u&&!M&&!g&&!W)continue;let U=ot(o,i),P=U-i.blockHeight;if(u&&(U-=i.waterSurfaceOffset,P-=i.waterSurfaceOffset),P<=0)continue;const T=R-o;let D;switch(r){case n.ORE_COAL:D=E;break;case n.ORE_COPPER:D=v;break;case n.ORE_IRON:D=C;break;case n.ORE_GOLD:D=L;break;case n.ORE_LITHIUM:D=a;break;case n.ORE_ALUMINUM:D=N;break;case n.ORE_COBALT:D=z;break;case n.STONE:D=b;break;case n.SAND:D=O;break;case n.DIRT:D=f;break;case n.WOOD:D=d;break;case n.SNOW:D=S;break;case n.DIRT_SNOW:D=_;break;case n.ICE:D=c;break;default:D=x;break}let F=1;T>0&&(F=Math.max(H,Math.pow(X,T)));const w=i.torches||[];if(u||M){const e=K(t.tile,P,U,!0,!1,!1,i.uvScale);e&&(u?k(A,e.positions,e.normals,e.uvs,e.indices,i.sunDirection,1,w):k(D,e.positions,e.normals,e.uvs,e.indices,i.sunDirection,F,w))}if(!u&&g){const e=K(t.tile,P,U,!1,!0,!1,i.uvScale);if(e){const Y=Math.max(H,F*X);r===n.GRASS?k(f,e.positions,e.normals,e.uvs,e.indices,i.sunDirection,Y,w):r===n.SNOW?k(_,e.positions,e.normals,e.uvs,e.indices,i.sunDirection,Y,w):k(D,e.positions,e.normals,e.uvs,e.indices,i.sunDirection,Y,w)}}if(!u&&W){const e=K(t.tile,P,U,!1,!1,!0,i.uvScale);e&&(r===n.GRASS?k(h,e.positions,e.normals,e.uvs,e.indices,i.sunDirection,F,w):r===n.SNOW?k(y,e.positions,e.normals,e.uvs,e.indices,i.sunDirection,F,w):k(D,e.positions,e.normals,e.uvs,e.indices,i.sunDirection,F,w))}}}self.onmessage=t=>{const{type:s,columns:i,neighborData:x,config:f}=t.data;if(s==="buildGeometry"){const h=I(),b=I(),O=I(),d=I(),A=I(),E=I(),v=I(),C=I(),L=I(),a=I(),N=I(),z=I(),S=I(),y=I(),_=I(),c=I(),R=I(),o=I(),r=new Map(Object.entries(x).map(([l,p])=>[parseInt(l),p]));for(const l of i){it(l,r,f,h,b,O,d,A,E,v,C,L,a,N,z,S,y,_,c,R,o);for(let p=0;p<l.blocks.length;p++)l.blocks[p]===n.WATER&&st(l.tile.vertices,l.tile.neighbors,l.blocks,r,p,f,v)}let u=0;for(const l of[h,b,O,d,A,E])u+=l.torchLight.filter(p=>p>0).length;(u>0||f.torches&&f.torches.length>0)&&console.log(`[GeometryWorker] Total non-zero torchLight values: ${u}`);const m={type:"geometryResult",topData:h,sideData:b,grassSideData:O,stoneData:d,sandData:A,woodData:E,waterData:v,oreCoalData:C,oreCopperData:L,oreIronData:a,oreGoldData:N,oreLithiumData:z,oreAluminumData:S,oreCobaltData:y,snowData:_,snowSideData:c,dirtSnowData:R,iceData:o};self.postMessage(m)}}})();
//# sourceMappingURL=geometryWorker-CjW9m9fr.js.map
