(function(){"use strict";function B(E,_,oe,he){let ne=0;for(const m of he){const M=E-m.position.x,F=_-m.position.y,b=oe-m.position.z,H=Math.sqrt(M*M+F*F+b*b);if(H<m.range){const K=1/(1+2*H*H/(m.range*m.range));ne+=K*m.intensity}}return Math.min(ne,1.5)}function xe(){return{grassPositions:[],grassNormals:[],grassUvs:[],grassSkyLight:[],grassTorchLight:[],grassIndices:[],grassVertexOffset:0,dirtPositions:[],dirtNormals:[],dirtUvs:[],dirtSkyLight:[],dirtTorchLight:[],dirtIndices:[],dirtVertexOffset:0,stonePositions:[],stoneNormals:[],stoneUvs:[],stoneSkyLight:[],stoneTorchLight:[],stoneIndices:[],stoneVertexOffset:0,sandPositions:[],sandNormals:[],sandUvs:[],sandSkyLight:[],sandTorchLight:[],sandIndices:[],sandVertexOffset:0,woodPositions:[],woodNormals:[],woodUvs:[],woodSkyLight:[],woodTorchLight:[],woodIndices:[],woodVertexOffset:0,waterPositions:[],waterNormals:[],waterUvs:[],waterIndices:[],waterVertexOffset:0,sidePositions:[],sideNormals:[],sideUvs:[],sideSkyLight:[],sideTorchLight:[],sideIndices:[],sideVertexOffset:0,waterSidePositions:[],waterSideNormals:[],waterSideUvs:[],waterSideIndices:[],waterSideVertexOffset:0,snowPositions:[],snowNormals:[],snowUvs:[],snowSkyLight:[],snowTorchLight:[],snowIndices:[],snowVertexOffset:0,icePositions:[],iceNormals:[],iceUvs:[],iceSkyLight:[],iceTorchLight:[],iceIndices:[],iceVertexOffset:0,moonRockPositions:[],moonRockNormals:[],moonRockUvs:[],moonRockSkyLight:[],moonRockTorchLight:[],moonRockIndices:[],moonRockVertexOffset:0,moonRockSidePositions:[],moonRockSideNormals:[],moonRockSideUvs:[],moonRockSideSkyLight:[],moonRockSideTorchLight:[],moonRockSideIndices:[],moonRockSideVertexOffset:0}}const d={AIR:0,STONE:1,DIRT:2,GRASS:3,WATER:4,SAND:5,WOOD:6,SNOW:15,DIRT_SNOW:16,ICE:17,GLASS:19,MOON_ROCK:22},ge=.5;function fe(E,_){return _.radius-(_.maxDepth-1-E)*_.blockHeight}function me(E){return E.maxDepth-1-E.seaLevel}let j=null,le=0;self.onmessage=E=>{const{type:_,tileData:oe,blockData:he,tileToChunk:ne,config:m,torches:M=[]}=E.data;if(_==="buildLODGeometry"){const F=new Map(Object.entries(ne).map(([g,O])=>[parseInt(g),O])),b=new Map;for(const[g,O]of Object.entries(oe)){const s=parseInt(g),a=he[s];a&&b.set(s,{tileIndex:s,tile:O,blocks:a})}const H=Object.keys(oe).length;if(!j||le!==H){j=new Map,le=H;for(const[g,O]of b){const s=O.tile,a=s.vertices.length,o=Math.sqrt(s.center.x*s.center.x+s.center.y*s.center.y+s.center.z*s.center.z),f=o>0?{x:s.center.x/o,y:s.center.y/o,z:s.center.z/o}:{x:0,y:0,z:0},e=[];for(const c of s.vertices){const S=Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z);e.push(S>0?{x:c.x/S,y:c.y/S,z:c.z/S}:{x:0,y:0,z:0})}const l=[];for(let c=0;c<a;c++){const S=(c+1)%a,I=s.vertices[c],R=s.vertices[S],z=I.x+R.x,L=I.y+R.y,k=I.z+R.z,w=Math.sqrt(z*z+L*L+k*k);l.push(w>0?{x:z/w,y:L/w,z:k/w}:{x:0,y:0,z:0})}const x=[];for(let c=0;c<a;c++){const S=l[c];let I=-1,R=1/0;for(const z of s.neighbors){const L=b.get(z);if(!L)continue;const k=L.tile.center,w=Math.sqrt(k.x*k.x+k.y*k.y+k.z*k.z);if(w===0)continue;const J=k.x/w,Q=k.y/w,$=k.z/w,A=J-S.x,X=Q-S.y,Y=$-S.z,Z=A*A+X*X+Y*Y;Z<R&&(R=Z,I=z)}x.push(I)}const i=Math.abs(f.y)<.9?{x:0,y:1,z:0}:{x:1,y:0,z:0},t=i.y*f.z-i.z*f.y,h=i.z*f.x-i.x*f.z,u=i.x*f.y-i.y*f.x,n=Math.sqrt(t*t+h*h+u*u),r=n>0?{x:t/n,y:h/n,z:u/n}:{x:1,y:0,z:0},q=f.y*r.z-f.z*r.y,v=f.z*r.x-f.x*r.z,T=f.x*r.y-f.y*r.x,p={x:q,y:v,z:T},U=[];let V=1/0,D=-1/0,y=1/0,N=-1/0;for(const c of s.vertices){const S=c.x-s.center.x,I=c.y-s.center.y,R=c.z-s.center.z,z=S*r.x+I*r.y+R*r.z,L=S*p.x+I*p.y+R*p.z;U.push({u:z,v:L}),V=Math.min(V,z),D=Math.max(D,z),y=Math.min(y,L),N=Math.max(N,L)}const P=D-V,W=N-y,G=U.map(c=>({u:(c.u-V)/P,v:(c.v-y)/W})),ce={u:(0-V)/P,v:(0-y)/W};j.set(g,{normalizedCenter:f,normalizedVertices:e,edgeMidDirs:l,edgeNeighborIdx:x,normalizedUVs:G,centerUV:ce})}}const K=[];for(let g=0;g<m.chunkCount;g++)K.push(xe());const ue=me(m),ye=fe(ue,m)-m.waterSurfaceOffset,ie=new Map;for(const[g,O]of b){let s=0,a=d.GRASS,o=0;const f=O.blocks;for(let i=f.length-1;i>=0;i--)if(f[i]!==d.AIR&&(a===d.GRASS&&(s=i,a=f[i]),f[i]!==d.WATER)){o=i;break}const e=a===d.WATER,l=e?ye:fe(s,m)-m.lodOffset,x=fe(o,m)-m.lodOffset;ie.set(g,{radius:l,isWater:e,surfaceBlockType:a,terrainRadius:x})}for(const[g]of b){const O=j.get(g),s=ie.get(g),a=s.radius,o=s.surfaceBlockType,f=F.get(g)??0,e=K[f];let l,x,i,t,h,u,n;o===d.WATER?(l=e.waterPositions,x=e.waterNormals,i=e.waterUvs,t=null,h=null,u=e.waterIndices,n=e.waterVertexOffset):o===d.DIRT?(l=e.dirtPositions,x=e.dirtNormals,i=e.dirtUvs,t=e.dirtSkyLight,h=e.dirtTorchLight,u=e.dirtIndices,n=e.dirtVertexOffset):o===d.STONE?(l=e.stonePositions,x=e.stoneNormals,i=e.stoneUvs,t=e.stoneSkyLight,h=e.stoneTorchLight,u=e.stoneIndices,n=e.stoneVertexOffset):o===d.SAND?(l=e.sandPositions,x=e.sandNormals,i=e.sandUvs,t=e.sandSkyLight,h=e.sandTorchLight,u=e.sandIndices,n=e.sandVertexOffset):o===d.WOOD?(l=e.woodPositions,x=e.woodNormals,i=e.woodUvs,t=e.woodSkyLight,h=e.woodTorchLight,u=e.woodIndices,n=e.woodVertexOffset):o===d.SNOW||o===d.DIRT_SNOW?(l=e.snowPositions,x=e.snowNormals,i=e.snowUvs,t=e.snowSkyLight,h=e.snowTorchLight,u=e.snowIndices,n=e.snowVertexOffset):o===d.ICE||o===d.GLASS?(l=e.icePositions,x=e.iceNormals,i=e.iceUvs,t=e.iceSkyLight,h=e.iceTorchLight,u=e.iceIndices,n=e.iceVertexOffset):o===d.MOON_ROCK?(l=e.moonRockPositions,x=e.moonRockNormals,i=e.moonRockUvs,t=e.moonRockSkyLight,h=e.moonRockTorchLight,u=e.moonRockIndices,n=e.moonRockVertexOffset):(l=e.grassPositions,x=e.grassNormals,i=e.grassUvs,t=e.grassSkyLight,h=e.grassTorchLight,u=e.grassIndices,n=e.grassVertexOffset);const r=O.normalizedCenter,q=O.normalizedVertices,v=O.normalizedUVs,T=O.centerUV,p=n,U=r.x*a,V=r.y*a,D=r.z*a;l.push(U,V,D),x.push(r.x,r.y,r.z),i.push(T.u,T.v),t&&t.push(1),h&&h.push(B(U,V,D,M)),n++;for(let y=0;y<q.length;y++){const N=q[y],P=N.x*a,W=N.y*a,G=N.z*a;l.push(P,W,G),x.push(r.x,r.y,r.z),i.push(v[y].u,v[y].v),t&&t.push(1),h&&h.push(B(P,W,G,M)),n++,u.push(p,p+1+y,p+1+(y+1)%q.length)}o===d.WATER?e.waterVertexOffset=n:o===d.DIRT?e.dirtVertexOffset=n:o===d.STONE?e.stoneVertexOffset=n:o===d.SAND?e.sandVertexOffset=n:o===d.WOOD?e.woodVertexOffset=n:o===d.SNOW||o===d.DIRT_SNOW?e.snowVertexOffset=n:o===d.ICE||o===d.GLASS?e.iceVertexOffset=n:o===d.MOON_ROCK?e.moonRockVertexOffset=n:e.grassVertexOffset=n}const Se=m.sideWallThreshold??ge;for(const[g]of b){const O=j.get(g),s=ie.get(g),a=s.radius,o=s.isWater,f=s.surfaceBlockType===d.MOON_ROCK,e=O.normalizedVertices,l=O.edgeNeighborIdx,x=e.length,i=F.get(g)??0,t=K[i];for(let h=0;h<x;h++){const u=l[h];if(u<0)continue;const n=ie.get(u);if(!n)continue;const r=n.radius;if(a<=r+Se)continue;const q=(h+1)%x,v=e[h],T=e[q],p=v.x*r,U=v.y*r,V=v.z*r,D=T.x*r,y=T.y*r,N=T.z*r,P=v.x*a,W=v.y*a,G=v.z*a,ce=T.x*a,c=T.y*a,S=T.z*a,I=D-p,R=y-U,z=N-V,L=P-p,k=W-U,w=G-V,J=R*w-z*k,Q=z*L-I*w,$=I*k-R*L,A=Math.sqrt(J*J+Q*Q+$*$),X=A>0?J/A:0,Y=A>0?Q/A:0,Z=A>0?$/A:0;let re,de,ae,ee,te,se,C;o?(re=t.waterSidePositions,de=t.waterSideNormals,ae=t.waterSideUvs,ee=null,te=null,se=t.waterSideIndices,C=t.waterSideVertexOffset):f?(re=t.moonRockSidePositions,de=t.moonRockSideNormals,ae=t.moonRockSideUvs,ee=t.moonRockSideSkyLight,te=t.moonRockSideTorchLight,se=t.moonRockSideIndices,C=t.moonRockSideVertexOffset):(re=t.sidePositions,de=t.sideNormals,ae=t.sideUvs,ee=t.sideSkyLight,te=t.sideTorchLight,se=t.sideIndices,C=t.sideVertexOffset),re.push(p,U,V,D,y,N,ce,c,S,P,W,G),de.push(X,Y,Z,X,Y,Z,X,Y,Z,X,Y,Z),ae.push(0,0,1,0,1,1,0,1),ee&&ee.push(1,1,1,1),te&&te.push(B(p,U,V,M),B(D,y,N,M),B(ce,c,S,M),B(P,W,G,M)),se.push(C,C+1,C+2),se.push(C,C+2,C+3),o?t.waterSideVertexOffset+=4:f?t.moonRockSideVertexOffset+=4:t.sideVertexOffset+=4}}const ke={type:"lodGeometryResult",chunkGeometries:K};self.postMessage(ke)}}})();
//# sourceMappingURL=lodGeometryWorker-B46hOWvC.js.map
