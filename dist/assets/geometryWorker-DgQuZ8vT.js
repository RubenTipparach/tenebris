(function(){"use strict";var e=(t=>(t[t.AIR=0]="AIR",t[t.STONE=1]="STONE",t[t.DIRT=2]="DIRT",t[t.GRASS=3]="GRASS",t[t.WATER=4]="WATER",t[t.SAND=5]="SAND",t[t.WOOD=6]="WOOD",t[t.LEAVES=7]="LEAVES",t[t.ORE_COAL=8]="ORE_COAL",t[t.ORE_COPPER=9]="ORE_COPPER",t[t.ORE_IRON=10]="ORE_IRON",t[t.ORE_GOLD=11]="ORE_GOLD",t[t.ORE_LITHIUM=12]="ORE_LITHIUM",t[t.ORE_ALUMINUM=13]="ORE_ALUMINUM",t[t.ORE_COBALT=14]="ORE_COBALT",t))(e||{});function F(t,s,l){return{x:t,y:s,z:l}}function j(t){return{x:t.x,y:t.y,z:t.z}}function w(t,s){return{x:t.x-s.x,y:t.y-s.y,z:t.z-s.z}}function C(t,s){return{x:t.x*s,y:t.y*s,z:t.z*s}}function Q(t,s){return t.x*s.x+t.y*s.y+t.z*s.z}function U(t,s){return{x:t.y*s.z-t.z*s.y,y:t.z*s.x-t.x*s.z,z:t.x*s.y-t.y*s.x}}function q(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}function N(t){const s=q(t);return s===0?{x:0,y:0,z:0}:{x:t.x/s,y:t.y/s,z:t.z/s}}function X(t){return{x:-t.x,y:-t.y,z:-t.z}}function K(t,s){return q(w(t,s))}const Y=.8,Z=.05;function B(t,s,l,S,d,A,O,a){const f=t.length,E=.001;for(let b=0;b<f;b++){const M=(b+1)%f,_=t[b],k=t[M];let c;for(const p of s){const v=S.get(p);if(!v)continue;let i=!1,P=!1;for(const J of v.vertices)K(J,_)<E&&(i=!0),K(J,k)<E&&(P=!0);if(i&&P){c=v;break}}if(!c||c.blocks[d]!==e.AIR)continue;let D=0;for(let p=d-1;p>=0;p--){const v=l[p];if(v!==e.AIR&&v!==e.WATER){D=p;break}}let z=0;for(let p=d-1;p>=0;p--){const v=c.blocks[p];if(v!==e.AIR&&v!==e.WATER){z=p;break}}const x=Math.max(D,z),u=A,m=O.radius-(O.maxDepth-1-x)*O.blockHeight;if(m>=u)continue;const n=N(_),R=N(k),o=C(n,u),r=C(R,u),I=C(n,m),y=C(R,m),L=w(y,I),G=w(o,I),W=N(U(L,G)),h=a.vertexOffset;a.positions.push(I.x,I.y,I.z,y.x,y.y,y.z,r.x,r.y,r.z,o.x,o.y,o.z);for(let p=0;p<4;p++)a.normals.push(W.x,W.y,W.z);a.uvs.push(0,0,1,0,1,1,0,1),a.skyLight.push(1,1,1,1),a.colors.push(1,1,1,1,1,1,1,1,1,1,1,1),a.indices.push(h,h+1,h+2,h,h+2,h+3),a.vertexOffset+=4}}function g(){return{positions:[],normals:[],uvs:[],colors:[],skyLight:[],torchLight:[],indices:[],vertexOffset:0}}function $(t,s){return s.radius-(s.maxDepth-1-t)*s.blockHeight}function H(t,s,l,S){let d=0;for(const A of S){const O=t-A.position.x,a=s-A.position.y,f=l-A.position.z,E=Math.sqrt(O*O+a*a+f*f);if(E<A.range){const b=1/(1+2*E*E/(A.range*A.range));d+=b*A.intensity}}return Math.min(d,1.5)}function tt(t,s,l){const S=t.blocks[s];if(S===e.AIR||S===e.WATER)return!1;for(const d of t.tile.neighbors){const A=l.get(d);if(!A)return!0;const O=A.blocks[s];if(O===void 0||O===e.AIR||O===e.WATER)return!0}return!1}function V(t,s,l,S,d,A,O,a=[]){const f=s.length/3,E=t.vertexOffset;t.positions.push.apply(t.positions,s),t.normals.push.apply(t.normals,l),t.uvs.push.apply(t.uvs,S);const b=new Array(f*3);for(let c=0;c<f;c++){const D=c*3;b[D]=1,b[D+1]=1,b[D+2]=1}t.colors.push.apply(t.colors,b);const M=new Array(f);for(let c=0;c<f;c++)M[c]=O;t.skyLight.push.apply(t.skyLight,M);const _=new Array(f);for(let c=0;c<f;c++){const D=s[c*3],z=s[c*3+1],x=s[c*3+2];_[c]=H(D,z,x,a)}t.torchLight.push.apply(t.torchLight,_);const k=new Array(d.length);for(let c=0;c<d.length;c++)k[c]=d[c]+E;t.indices.push.apply(t.indices,k),t.vertexOffset+=f}function T(t,s,l,S,d,A,O=10){const a=t.vertices.length,f=N(t.center),E=[],b=[];for(const n of t.vertices){const R=N(n);E.push(C(R,s)),b.push(C(R,l))}const M=C(f,s),_=C(f,l),k=j(f);let c=F(1,0,0);Math.abs(Q(k,c))>.9&&(c=F(0,0,1));const D=N(U(k,c));c=N(U(D,k));const z=[],x=[],u=[],m=[];if(S){const n=j(f);z.push(_.x,_.y,_.z),x.push(n.x,n.y,n.z),u.push(.5,.5);const R=.5;for(let o=0;o<a;o++){const r=b[o];z.push(r.x,r.y,r.z),x.push(n.x,n.y,n.z);const I=o/a*Math.PI*2-Math.PI/2,y=.5+Math.cos(I)*R,L=.5+Math.sin(I)*R;u.push(y,L)}for(let o=0;o<a;o++){const r=(o+1)%a;m.push(0,1+o,1+r)}}else if(d){const n=X(f);z.push(M.x,M.y,M.z),x.push(n.x,n.y,n.z),u.push(.5,.5);const R=.5;for(let o=0;o<a;o++){const r=E[o];z.push(r.x,r.y,r.z),x.push(n.x,n.y,n.z);const I=o/a*Math.PI*2-Math.PI/2,y=.5+Math.cos(I)*R,L=.5+Math.sin(I)*R;u.push(y,L)}for(let o=0;o<a;o++){const r=(o+1)%a;m.push(0,1+r,1+o)}}else if(A){let n=0;for(let R=0;R<a;R++){const o=(R+1)%a,r=b[R],I=b[o],y=E[R],L=E[o],G=w(L,y),W=w(r,y),h=N(U(G,W));z.push(y.x,y.y,y.z,L.x,L.y,L.z,I.x,I.y,I.z,r.x,r.y,r.z);for(let p=0;p<4;p++)x.push(h.x,h.y,h.z);u.push(0,0,1,0,1,1,0,1),m.push(n,n+1,n+2,n,n+2,n+3),n+=4}}return z.length===0?null:{positions:z,normals:x,uvs:u,indices:m}}function st(t,s,l,S,d,A,O,a,f,E,b,M,_,k,c,D,z){let x=0;for(let u=t.blocks.length-1;u>=0;u--)if(t.blocks[u]!==e.AIR&&t.blocks[u]!==e.WATER){x=u;break}for(let u=0;u<t.blocks.length;u++){const m=t.blocks[u];if(m===e.AIR)continue;const n=m===e.WATER,R=u>=t.blocks.length-1?e.AIR:t.blocks[u+1],o=u===0?e.AIR:t.blocks[u-1],r=R===e.AIR||!n&&R===e.WATER,I=o===e.AIR||!n&&o===e.WATER;if(n&&R!==e.AIR)continue;const y=!n&&tt(t,u,s);if(!n&&!r&&!I&&!y)continue;let L=$(u,l),G=L-l.blockHeight;if(n&&(L-=l.waterSurfaceOffset,G-=l.waterSurfaceOffset),G<=0)continue;const W=x-u;let h;switch(m){case e.ORE_COAL:h=b;break;case e.ORE_COPPER:h=M;break;case e.ORE_IRON:h=_;break;case e.ORE_GOLD:h=k;break;case e.ORE_LITHIUM:h=c;break;case e.ORE_ALUMINUM:h=D;break;case e.ORE_COBALT:h=z;break;case e.STONE:h=O;break;case e.SAND:h=a;break;case e.DIRT:h=d;break;case e.WOOD:h=f;break;default:h=S;break}let p=1;W>0&&(p=Math.max(Z,Math.pow(Y,W)));const v=l.torches||[];if(n||r){const i=T(t.tile,G,L,!0,!1,!1,l.uvScale);i&&(n?V(E,i.positions,i.normals,i.uvs,i.indices,l.sunDirection,1,v):V(h,i.positions,i.normals,i.uvs,i.indices,l.sunDirection,p,v))}if(!n&&I){const i=T(t.tile,G,L,!1,!0,!1,l.uvScale);if(i){const P=Math.max(Z,p*Y);m===e.GRASS?V(d,i.positions,i.normals,i.uvs,i.indices,l.sunDirection,P,v):V(h,i.positions,i.normals,i.uvs,i.indices,l.sunDirection,P,v)}}if(!n&&y){const i=T(t.tile,G,L,!1,!1,!0,l.uvScale);i&&(m===e.GRASS?V(A,i.positions,i.normals,i.uvs,i.indices,l.sunDirection,p,v):V(h,i.positions,i.normals,i.uvs,i.indices,l.sunDirection,p,v))}}}self.onmessage=t=>{const{type:s,columns:l,neighborData:S,config:d}=t.data;if(s==="buildGeometry"){const A=g(),O=g(),a=g(),f=g(),E=g(),b=g(),M=g(),_=g(),k=g(),c=g(),D=g(),z=g(),x=g(),u=g(),m=new Map(Object.entries(S).map(([o,r])=>[parseInt(o),r]));for(const o of l){st(o,m,d,A,O,a,f,E,b,M,_,k,c,D,z,x,u);for(let r=0;r<o.blocks.length;r++)if(o.blocks[r]===e.WATER&&(r>=o.blocks.length-1?e.AIR:o.blocks[r+1])===e.AIR){const y=$(r,d)-d.waterSurfaceOffset;B(o.tile.vertices,o.tile.neighbors,o.blocks,m,r,y,d,M)}}let n=0;for(const o of[A,O,a,f,E,b])n+=o.torchLight.filter(r=>r>0).length;(n>0||d.torches&&d.torches.length>0)&&console.log(`[GeometryWorker] Total non-zero torchLight values: ${n}`);const R={type:"geometryResult",topData:A,sideData:O,grassSideData:a,stoneData:f,sandData:E,woodData:b,waterData:M,oreCoalData:_,oreCopperData:k,oreIronData:c,oreGoldData:D,oreLithiumData:z,oreAluminumData:x,oreCobaltData:u};self.postMessage(R)}}})();
//# sourceMappingURL=geometryWorker-DgQuZ8vT.js.map
