(function(){"use strict";var n=(t=>(t[t.AIR=0]="AIR",t[t.STONE=1]="STONE",t[t.DIRT=2]="DIRT",t[t.GRASS=3]="GRASS",t[t.WATER=4]="WATER",t[t.SAND=5]="SAND",t[t.WOOD=6]="WOOD",t[t.LEAVES=7]="LEAVES",t[t.ORE_COAL=8]="ORE_COAL",t[t.ORE_COPPER=9]="ORE_COPPER",t[t.ORE_IRON=10]="ORE_IRON",t[t.ORE_GOLD=11]="ORE_GOLD",t[t.ORE_LITHIUM=12]="ORE_LITHIUM",t[t.ORE_ALUMINUM=13]="ORE_ALUMINUM",t[t.ORE_COBALT=14]="ORE_COBALT",t))(n||{});function $(t,o,a){return{x:t,y:o,z:a}}function T(t){return{x:t.x,y:t.y,z:t.z}}function V(t,o){return{x:t.x-o.x,y:t.y-o.y,z:t.z-o.z}}function C(t,o){return{x:t.x*o,y:t.y*o,z:t.z*o}}function Z(t,o){return t.x*o.x+t.y*o.y+t.z*o.z}function P(t,o){return{x:t.y*o.z-t.z*o.y,y:t.z*o.x-t.x*o.z,z:t.x*o.y-t.y*o.x}}function j(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}function W(t){const o=j(t);return o===0?{x:0,y:0,z:0}:{x:t.x/o,y:t.y/o,z:t.z/o}}function B(t){return{x:-t.x,y:-t.y,z:-t.z}}function q(t,o){return j(V(t,o))}const K=.8,Y=.05;function H(t,o,a,M,d,O,y,l){const R=t.length,x=.001;for(let A=0;A<R;A++){const _=(A+1)%R,k=t[A],v=t[_];let r;for(const b of o){const L=M.get(b);if(!L)continue;let c=!1,w=!1;for(const X of L.vertices)q(X,k)<x&&(c=!0),q(X,v)<x&&(w=!0);if(c&&w){r=L;break}}if(!r||r.blocks[d]!==n.AIR)continue;let D=0;for(let b=d-1;b>=0;b--){const L=a[b];if(L!==n.AIR&&L!==n.WATER){D=b;break}}let m=0;for(let b=d-1;b>=0;b--){const L=r.blocks[b];if(L!==n.AIR&&L!==n.WATER){m=b;break}}const g=Math.max(D,m),u=O,z=y.radius-(y.maxDepth-1-g)*y.blockHeight;if(z>=u)continue;const s=W(k),p=W(v),i=C(s,u),e=C(p,u),h=C(s,z),E=C(p,z),I=V(E,h),G=V(i,h),N=W(P(I,G)),f=l.vertexOffset;l.positions.push(h.x,h.y,h.z,E.x,E.y,E.z,e.x,e.y,e.z,i.x,i.y,i.z);for(let b=0;b<4;b++)l.normals.push(N.x,N.y,N.z);l.uvs.push(0,0,1,0,1,1,0,1),l.skyLight.push(1,1,1,1),l.colors.push(1,1,1,1,1,1,1,1,1,1,1,1),l.indices.push(f,f+1,f+2,f,f+2,f+3),l.vertexOffset+=4}}function S(){return{positions:[],normals:[],uvs:[],colors:[],skyLight:[],torchLight:[],indices:[],vertexOffset:0}}function J(t,o){return o.radius-(o.maxDepth-1-t)*o.blockHeight}let Q=!1;function tt(t,o,a,M){let d=0;for(const O of M){const y=t-O.position.x,l=o-O.position.y,R=a-O.position.z,x=Math.sqrt(y*y+l*l+R*R);if(x<O.range){const A=1/(1+2*x*x/(O.range*O.range));d+=A*O.intensity,Q||(console.log(`[GeometryWorker] Torch light hit! vertex=(${t.toFixed(2)},${o.toFixed(2)},${a.toFixed(2)}), dist=${x.toFixed(2)}, light=${d.toFixed(3)}`),Q=!0)}}return Math.min(d,1.5)}function ot(t,o,a){const M=t.blocks[o];if(M===n.AIR||M===n.WATER)return!1;for(const d of t.tile.neighbors){const O=a.get(d);if(!O)return!0;const y=O.blocks[o];if(y===void 0||y===n.AIR||y===n.WATER)return!0}return!1}function F(t,o,a,M,d,O,y,l=[]){const R=o.length/3,x=t.vertexOffset;t.positions.push.apply(t.positions,o),t.normals.push.apply(t.normals,a),t.uvs.push.apply(t.uvs,M);const A=new Array(R*3);for(let r=0;r<R;r++){const D=r*3;A[D]=1,A[D+1]=1,A[D+2]=1}t.colors.push.apply(t.colors,A);const _=new Array(R);for(let r=0;r<R;r++)_[r]=y;t.skyLight.push.apply(t.skyLight,_);const k=new Array(R);for(let r=0;r<R;r++){const D=o[r*3],m=o[r*3+1],g=o[r*3+2];k[r]=tt(D,m,g,l)}t.torchLight.push.apply(t.torchLight,k);const v=new Array(d.length);for(let r=0;r<d.length;r++)v[r]=d[r]+x;t.indices.push.apply(t.indices,v),t.vertexOffset+=R}function U(t,o,a,M,d,O,y=10){const l=t.vertices.length,R=W(t.center),x=[],A=[];for(const s of t.vertices){const p=W(s);x.push(C(p,o)),A.push(C(p,a))}const _=C(R,o),k=C(R,a),v=T(R);let r=$(1,0,0);Math.abs(Z(v,r))>.9&&(r=$(0,0,1));const D=W(P(v,r));r=W(P(D,v));const m=[],g=[],u=[],z=[];if(M){const s=T(R);m.push(k.x,k.y,k.z),g.push(s.x,s.y,s.z),u.push(.5,.5);const p=.5;for(let i=0;i<l;i++){const e=A[i];m.push(e.x,e.y,e.z),g.push(s.x,s.y,s.z);const h=i/l*Math.PI*2-Math.PI/2,E=.5+Math.cos(h)*p,I=.5+Math.sin(h)*p;u.push(E,I)}for(let i=0;i<l;i++){const e=(i+1)%l;z.push(0,1+i,1+e)}}else if(d){const s=B(R);m.push(_.x,_.y,_.z),g.push(s.x,s.y,s.z),u.push(.5,.5);const p=.5;for(let i=0;i<l;i++){const e=x[i];m.push(e.x,e.y,e.z),g.push(s.x,s.y,s.z);const h=i/l*Math.PI*2-Math.PI/2,E=.5+Math.cos(h)*p,I=.5+Math.sin(h)*p;u.push(E,I)}for(let i=0;i<l;i++){const e=(i+1)%l;z.push(0,1+e,1+i)}}else if(O){let s=0;for(let p=0;p<l;p++){const i=(p+1)%l,e=A[p],h=A[i],E=x[p],I=x[i],G=V(I,E),N=V(e,E),f=W(P(G,N));m.push(E.x,E.y,E.z,I.x,I.y,I.z,h.x,h.y,h.z,e.x,e.y,e.z);for(let b=0;b<4;b++)g.push(f.x,f.y,f.z);u.push(0,0,1,0,1,1,0,1),z.push(s,s+1,s+2,s,s+2,s+3),s+=4}}return m.length===0?null:{positions:m,normals:g,uvs:u,indices:z}}function st(t,o,a,M,d,O,y,l,R,x,A,_,k,v,r,D,m){let g=0;for(let u=t.blocks.length-1;u>=0;u--)if(t.blocks[u]!==n.AIR&&t.blocks[u]!==n.WATER){g=u;break}for(let u=0;u<t.blocks.length;u++){const z=t.blocks[u];if(z===n.AIR)continue;const s=z===n.WATER,p=u>=t.blocks.length-1?n.AIR:t.blocks[u+1],i=u===0?n.AIR:t.blocks[u-1],e=p===n.AIR||!s&&p===n.WATER,h=i===n.AIR||!s&&i===n.WATER;if(s&&p!==n.AIR)continue;const E=!s&&ot(t,u,o);if(!s&&!e&&!h&&!E)continue;let I=J(u,a),G=I-a.blockHeight;if(s&&(I-=a.waterSurfaceOffset,G-=a.waterSurfaceOffset),G<=0)continue;const N=g-u;let f;switch(z){case n.ORE_COAL:f=A;break;case n.ORE_COPPER:f=_;break;case n.ORE_IRON:f=k;break;case n.ORE_GOLD:f=v;break;case n.ORE_LITHIUM:f=r;break;case n.ORE_ALUMINUM:f=D;break;case n.ORE_COBALT:f=m;break;case n.STONE:f=y;break;case n.SAND:f=l;break;case n.DIRT:f=d;break;case n.WOOD:f=R;break;default:f=M;break}let b=1;N>0&&(b=Math.max(Y,Math.pow(K,N)));const L=a.torches||[];if(s||e){const c=U(t.tile,G,I,!0,!1,!1,a.uvScale);c&&(s?F(x,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,1,L):F(f,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,b,L))}if(!s&&h){const c=U(t.tile,G,I,!1,!0,!1,a.uvScale);if(c){const w=Math.max(Y,b*K);z===n.GRASS?F(d,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,w,L):F(f,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,w,L)}}if(!s&&E){const c=U(t.tile,G,I,!1,!1,!0,a.uvScale);c&&(z===n.GRASS?F(O,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,b,L):F(f,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,b,L))}}}self.onmessage=t=>{var O;const{type:o,columns:a,neighborData:M,config:d}=t.data;if(o==="buildGeometry"){const y=((O=d.torches)==null?void 0:O.length)||0;if(console.log(`[GeometryWorker] Received ${y} torches`),y>0){const e=d.torches[0];console.log(`[GeometryWorker] First torch: pos=(${e.position.x.toFixed(2)}, ${e.position.y.toFixed(2)}, ${e.position.z.toFixed(2)}), range=${e.range}`)}const l=S(),R=S(),x=S(),A=S(),_=S(),k=S(),v=S(),r=S(),D=S(),m=S(),g=S(),u=S(),z=S(),s=S(),p=new Map(Object.entries(M).map(([e,h])=>[parseInt(e),h]));for(const e of a){st(e,p,d,l,R,x,A,_,k,v,r,D,m,g,u,z,s);for(let h=0;h<e.blocks.length;h++)if(e.blocks[h]===n.WATER&&(h>=e.blocks.length-1?n.AIR:e.blocks[h+1])===n.AIR){const I=J(h,d)-d.waterSurfaceOffset;H(e.tile.vertices,e.tile.neighbors,e.blocks,p,h,I,d,v)}}const i={type:"geometryResult",topData:l,sideData:R,grassSideData:x,stoneData:A,sandData:_,woodData:k,waterData:v,oreCoalData:r,oreCopperData:D,oreIronData:m,oreGoldData:g,oreLithiumData:u,oreAluminumData:z,oreCobaltData:s};self.postMessage(i)}}})();
//# sourceMappingURL=geometryWorker-CFUyd0hF.js.map
