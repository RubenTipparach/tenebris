(function(){"use strict";var c=(s=>(s[s.AIR=0]="AIR",s[s.STONE=1]="STONE",s[s.DIRT=2]="DIRT",s[s.GRASS=3]="GRASS",s[s.WATER=4]="WATER",s[s.SAND=5]="SAND",s[s.WOOD=6]="WOOD",s[s.LEAVES=7]="LEAVES",s))(c||{});function P(s,o,e){return{x:s,y:o,z:e}}function j(s){return{x:s.x,y:s.y,z:s.z}}function C(s,o){return{x:s.x-o.x,y:s.y-o.y,z:s.z-o.z}}function V(s,o){return{x:s.x*o,y:s.y*o,z:s.z*o}}function Z(s,o){return s.x*o.x+s.y*o.y+s.z*o.z}function F(s,o){return{x:s.y*o.z-s.z*o.y,y:s.z*o.x-s.x*o.z,z:s.x*o.y-s.y*o.x}}function w(s){return Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z)}function G(s){const o=w(s);return o===0?{x:0,y:0,z:0}:{x:s.x/o,y:s.y/o,z:s.z/o}}function $(s){return{x:-s.x,y:-s.y,z:-s.z}}function K(s,o){return w(C(s,o))}const Y=.8,q=.05;function B(s,o,e,M,p,W,A,n){const R=s.length,z=.001;for(let y=0;y<R;y++){const u=(y+1)%R,l=s[y],a=s[u];let f;for(const v of o){const L=M.get(v);if(!L)continue;let J=!1,Q=!1;for(const X of L.vertices)K(X,l)<z&&(J=!0),K(X,a)<z&&(Q=!0);if(J&&Q){f=L;break}}if(!f||f.blocks[p]!==c.AIR)continue;let I=p+1;for(let v=p+1;v<e.length;v++){const L=e[v];if(L!==c.AIR&&L!==c.WATER){I=v;break}}let D=p+1;for(let v=p+1;v<f.blocks.length;v++){const L=f.blocks[v];if(L!==c.AIR&&L!==c.WATER){D=v;break}else if(L===c.AIR)D=v+1;else break}const E=Math.min(I,D),O=W,k=A.radius-(A.maxDepth-1-E)*A.blockHeight;if(k>=O)continue;const i=G(l),x=G(a),r=V(i,O),h=V(x,O),b=V(i,k),m=V(x,k),d=C(m,b),t=C(r,b),T=G(F(d,t)),g=n.vertexOffset;n.positions.push(b.x,b.y,b.z,m.x,m.y,m.z,h.x,h.y,h.z,r.x,r.y,r.z);for(let v=0;v<4;v++)n.normals.push(T.x,T.y,T.z);n.uvs.push(0,0,1,0,1,1,0,1),n.skyLight.push(1,1,1,1),n.colors.push(1,1,1,1,1,1,1,1,1,1,1,1),n.indices.push(g,g+1,g+2,g,g+2,g+3),n.vertexOffset+=4}}function N(){return{positions:[],normals:[],uvs:[],colors:[],skyLight:[],indices:[],vertexOffset:0}}function U(s,o){return o.radius-(o.maxDepth-1-s)*o.blockHeight}function H(s,o,e){const M=s.blocks[o];if(M===c.AIR||M===c.WATER)return!1;for(const p of s.tile.neighbors){const W=e.get(p);if(!W)return!0;const A=W.blocks[o];if(A===void 0||A===c.AIR||A===c.WATER)return!0}return!1}function S(s,o,e,M,p,W,A){const n=o.length/3,R=s.vertexOffset;s.positions.push.apply(s.positions,o),s.normals.push.apply(s.normals,e),s.uvs.push.apply(s.uvs,M);const z=new Array(n*3);for(let l=0;l<n;l++){const a=l*3;z[a]=1,z[a+1]=1,z[a+2]=1}s.colors.push.apply(s.colors,z);const y=new Array(n);for(let l=0;l<n;l++)y[l]=A;s.skyLight.push.apply(s.skyLight,y);const u=new Array(p.length);for(let l=0;l<p.length;l++)u[l]=p[l]+R;s.indices.push.apply(s.indices,u),s.vertexOffset+=n}function _(s,o,e,M,p,W,A=10){const n=s.vertices.length,R=G(s.center),z=[],y=[];for(const i of s.vertices){const x=G(i);z.push(V(x,o)),y.push(V(x,e))}const u=V(R,o),l=V(R,e),a=j(R);let f=P(1,0,0);Math.abs(Z(a,f))>.9&&(f=P(0,0,1));const I=G(F(a,f));f=G(F(I,a));const D=[],E=[],O=[],k=[];if(M){const i=j(R);D.push(l.x,l.y,l.z),E.push(i.x,i.y,i.z),O.push(.5,.5);const x=.5;for(let r=0;r<n;r++){const h=y[r];D.push(h.x,h.y,h.z),E.push(i.x,i.y,i.z);const b=r/n*Math.PI*2-Math.PI/2,m=.5+Math.cos(b)*x,d=.5+Math.sin(b)*x;O.push(m,d)}for(let r=0;r<n;r++){const h=(r+1)%n;k.push(0,1+r,1+h)}}else if(p){const i=$(R);D.push(u.x,u.y,u.z),E.push(i.x,i.y,i.z),O.push(.5,.5);const x=.5;for(let r=0;r<n;r++){const h=z[r];D.push(h.x,h.y,h.z),E.push(i.x,i.y,i.z);const b=r/n*Math.PI*2-Math.PI/2,m=.5+Math.cos(b)*x,d=.5+Math.sin(b)*x;O.push(m,d)}for(let r=0;r<n;r++){const h=(r+1)%n;k.push(0,1+h,1+r)}}else if(W){let i=0;for(let x=0;x<n;x++){const r=(x+1)%n,h=y[x],b=y[r],m=z[x],d=z[r],t=C(d,m),T=C(h,m),g=G(F(t,T));D.push(m.x,m.y,m.z,d.x,d.y,d.z,b.x,b.y,b.z,h.x,h.y,h.z);for(let v=0;v<4;v++)E.push(g.x,g.y,g.z);O.push(0,0,1,0,1,1,0,1),k.push(i,i+1,i+2,i,i+2,i+3),i+=4}}return D.length===0?null:{positions:D,normals:E,uvs:O,indices:k}}function ss(s,o,e,M,p,W,A,n,R,z){let y=0;for(let u=s.blocks.length-1;u>=0;u--)if(s.blocks[u]!==c.AIR&&s.blocks[u]!==c.WATER){y=u;break}for(let u=0;u<s.blocks.length;u++){const l=s.blocks[u];if(l===c.AIR)continue;const a=l===c.WATER,f=u>=s.blocks.length-1?c.AIR:s.blocks[u+1],I=u===0?c.AIR:s.blocks[u-1],D=f===c.AIR||!a&&f===c.WATER,E=I===c.AIR||!a&&I===c.WATER;if(a&&f!==c.AIR)continue;const O=!a&&H(s,u,o);if(!a&&!D&&!E&&!O)continue;let k=U(u,e),i=k-e.blockHeight;if(a&&(k-=e.waterSurfaceOffset,i-=e.waterSurfaceOffset),i<=0)continue;const x=y-u,r=l===c.STONE,h=l===c.SAND,b=l===c.DIRT,m=l===c.WOOD;let d=1;if(x>0&&(d=Math.max(q,Math.pow(Y,x))),a||D){const t=_(s.tile,i,k,!0,!1,!1,e.uvScale);t&&(a?S(z,t.positions,t.normals,t.uvs,t.indices,e.sunDirection,1):S(r?A:h?n:b?p:m?R:M,t.positions,t.normals,t.uvs,t.indices,e.sunDirection,d))}if(!a&&E){const t=_(s.tile,i,k,!1,!0,!1,e.uvScale);if(t){const T=Math.max(q,d*Y);S(r?A:h?n:m?R:p,t.positions,t.normals,t.uvs,t.indices,e.sunDirection,T)}}if(!a&&O){const t=_(s.tile,i,k,!1,!1,!0,e.uvScale);t&&S(r?A:h?n:b?p:m?R:W,t.positions,t.normals,t.uvs,t.indices,e.sunDirection,d)}}}self.onmessage=s=>{const{type:o,columns:e,neighborData:M,config:p}=s.data;if(o==="buildGeometry"){const W=N(),A=N(),n=N(),R=N(),z=N(),y=N(),u=N(),l=new Map(Object.entries(M).map(([f,I])=>[parseInt(f),I]));for(const f of e){ss(f,l,p,W,A,n,R,z,y,u);for(let I=0;I<f.blocks.length;I++)if(f.blocks[I]===c.WATER&&(I>=f.blocks.length-1?c.AIR:f.blocks[I+1])===c.AIR){const E=U(I,p)-p.waterSurfaceOffset;B(f.tile.vertices,f.tile.neighbors,f.blocks,l,I,E,p,u)}}const a={type:"geometryResult",topData:W,sideData:A,grassSideData:n,stoneData:R,sandData:z,woodData:y,waterData:u};self.postMessage(a)}}})();
//# sourceMappingURL=geometryWorker-BbhpZ1ES.js.map
