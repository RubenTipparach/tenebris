(function(){"use strict";var s=(t=>(t[t.AIR=0]="AIR",t[t.STONE=1]="STONE",t[t.DIRT=2]="DIRT",t[t.GRASS=3]="GRASS",t[t.WATER=4]="WATER",t[t.SAND=5]="SAND",t[t.WOOD=6]="WOOD",t[t.LEAVES=7]="LEAVES",t[t.ORE_COAL=8]="ORE_COAL",t[t.ORE_COPPER=9]="ORE_COPPER",t[t.ORE_IRON=10]="ORE_IRON",t[t.ORE_GOLD=11]="ORE_GOLD",t[t.ORE_LITHIUM=12]="ORE_LITHIUM",t[t.ORE_ALUMINUM=13]="ORE_ALUMINUM",t[t.ORE_COBALT=14]="ORE_COBALT",t[t.SNOW=15]="SNOW",t[t.DIRT_SNOW=16]="DIRT_SNOW",t[t.ICE=17]="ICE",t[t.FURNACE=18]="FURNACE",t[t.GLASS=19]="GLASS",t[t.COMPUTER=20]="COMPUTER",t[t.PRINTER_3D=21]="PRINTER_3D",t[t.MOON_ROCK=22]="MOON_ROCK",t))(s||{});function Q(t,n,r){return{x:t,y:n,z:r}}function X(t){return{x:t.x,y:t.y,z:t.z}}function F(t,n){return{x:t.x-n.x,y:t.y-n.y,z:t.z-n.z}}function x(t,n){return{x:t.x*n,y:t.y*n,z:t.z*n}}function nt(t,n){return t.x*n.x+t.y*n.y+t.z*n.z}function Z(t,n){return{x:t.y*n.z-t.z*n.y,y:t.z*n.x-t.x*n.z,z:t.x*n.y-t.y*n.x}}function T(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}function P(t){const n=T(t);return n===0?{x:0,y:0,z:0}:{x:t.x/n,y:t.y/n,z:t.z/n}}function ot(t){return{x:-t.x,y:-t.y,z:-t.z}}function H(t,n){return T(F(t,n))}const B=.8,tt=.05;function et(t,n,r,_,l,h,S){if(r[l]!==s.WATER)return;const O=t.length,f=.001;for(let I=0;I<O;I++){const m=(I+1)%O,v=t[I],M=t[m];let C;for(const d of n){const W=_.get(d);if(!W)continue;let k=!1,K=!1;for(const j of W.vertices)H(j,v)<f&&(k=!0),H(j,M)<f&&(K=!0);if(k&&K){C=W;break}}if(!C||C.blocks[l]!==s.AIR)continue;const G=(l<r.length-1?r[l+1]:s.AIR)!==s.WATER,p=h.radius-(h.maxDepth-1-l)*h.blockHeight,z=G?p-h.waterSurfaceOffset:p,N=h.radius-(h.maxDepth-l)*h.blockHeight;if(N>=z)continue;const g=P(v),i=P(M),A=x(g,z),c=x(i,z),u=x(g,N),e=x(i,N),E=F(e,u),R=F(A,u),y=P(Z(E,R)),b=S.vertexOffset;S.positions.push(u.x,u.y,u.z,e.x,e.y,e.z,c.x,c.y,c.z,A.x,A.y,A.z);for(let d=0;d<4;d++)S.normals.push(y.x,y.y,y.z);S.uvs.push(0,0,1,0,1,1,0,1),S.skyLight.push(1,1,1,1),S.colors.push(1,1,1,1,1,1,1,1,1,1,1,1),S.indices.push(b,b+1,b+2,b,b+2,b+3),S.vertexOffset+=4}}function D(){return{positions:[],normals:[],uvs:[],colors:[],skyLight:[],torchLight:[],indices:[],vertexOffset:0}}function rt(t,n){return n.radius-(n.maxDepth-1-t)*n.blockHeight}function it(t,n,r,_){let l=0;for(const h of _){const S=t-h.position.x,O=n-h.position.y,f=r-h.position.z,I=Math.sqrt(S*S+O*O+f*f);if(I<h.range){const m=1/(1+2*I*I/(h.range*h.range));l+=m*h.intensity}}return Math.min(l,1.5)}function ct(t){return t===s.AIR||t===s.WATER||t===s.ICE||t===s.GLASS}function at(t,n,r){const _=t.blocks[n];if(_===s.AIR||_===s.WATER)return!1;for(const l of t.tile.neighbors){const h=r.get(l);if(!h)return!0;const S=h.blocks[n];if(S===void 0||ct(S))return!0}return!1}function U(t,n,r,_,l,h,S,O=[]){const f=n.length/3,I=t.vertexOffset;t.positions.push.apply(t.positions,n),t.normals.push.apply(t.normals,r),t.uvs.push.apply(t.uvs,_);const m=new Array(f*3);for(let a=0;a<f;a++){const G=a*3;m[G]=1,m[G+1]=1,m[G+2]=1}t.colors.push.apply(t.colors,m);const v=new Array(f);for(let a=0;a<f;a++)v[a]=S;t.skyLight.push.apply(t.skyLight,v);const M=new Array(f);for(let a=0;a<f;a++){const G=n[a*3],p=n[a*3+1],z=n[a*3+2];M[a]=it(G,p,z,O)}t.torchLight.push.apply(t.torchLight,M);const C=new Array(l.length);for(let a=0;a<l.length;a++)C[a]=l[a]+I;t.indices.push.apply(t.indices,C),t.vertexOffset+=f}function $(t,n,r,_,l,h,S=10){const O=t.vertices.length,f=P(t.center),I=[],m=[];for(const i of t.vertices){const A=P(i);I.push(x(A,n)),m.push(x(A,r))}const v=x(f,n),M=x(f,r),C=X(f);let a=Q(1,0,0);Math.abs(nt(C,a))>.9&&(a=Q(0,0,1));const G=P(Z(C,a));a=P(Z(G,C));const p=[],z=[],N=[],g=[];if(_){const i=X(f);p.push(M.x,M.y,M.z),z.push(i.x,i.y,i.z),N.push(.5,.5);const A=.5;for(let c=0;c<O;c++){const u=m[c];p.push(u.x,u.y,u.z),z.push(i.x,i.y,i.z);const e=c/O*Math.PI*2-Math.PI/2,E=.5+Math.cos(e)*A,R=.5+Math.sin(e)*A;N.push(E,R)}for(let c=0;c<O;c++){const u=(c+1)%O;g.push(0,1+c,1+u)}}else if(l){const i=ot(f);p.push(v.x,v.y,v.z),z.push(i.x,i.y,i.z),N.push(.5,.5);const A=.5;for(let c=0;c<O;c++){const u=I[c];p.push(u.x,u.y,u.z),z.push(i.x,i.y,i.z);const e=c/O*Math.PI*2-Math.PI/2,E=.5+Math.cos(e)*A,R=.5+Math.sin(e)*A;N.push(E,R)}for(let c=0;c<O;c++){const u=(c+1)%O;g.push(0,1+u,1+c)}}else if(h){let i=0;for(let A=0;A<O;A++){const c=(A+1)%O,u=m[A],e=m[c],E=I[A],R=I[c],y=F(R,E),b=F(u,E),d=P(Z(y,b));p.push(E.x,E.y,E.z,R.x,R.y,R.z,e.x,e.y,e.z,u.x,u.y,u.z);for(let W=0;W<4;W++)z.push(d.x,d.y,d.z);N.push(0,0,1,0,1,1,0,1),g.push(i,i+1,i+2,i,i+2,i+3),i+=4}}return p.length===0?null:{positions:p,normals:z,uvs:N,indices:g}}function ut(t,n,r,_,l,h,S,O,f,I,m,v,M,C,a,G,p,z,N,g,i,A,c){let u=0;for(let e=t.blocks.length-1;e>=0;e--)if(t.blocks[e]!==s.AIR&&t.blocks[e]!==s.WATER){u=e;break}for(let e=0;e<t.blocks.length;e++){const E=t.blocks[e];if(E===s.AIR)continue;const R=E===s.WATER,y=E===s.ICE,b=E===s.GLASS,d=e>=t.blocks.length-1?s.AIR:t.blocks[e+1],W=e===0?s.AIR:t.blocks[e-1],k=d===s.AIR||!R&&d===s.WATER||!y&&!b&&(d===s.ICE||d===s.GLASS),K=W===s.AIR||!R&&W===s.WATER||!y&&!b&&(W===s.ICE||W===s.GLASS);if(R&&d!==s.AIR&&d!==s.ICE&&d!==s.GLASS)continue;const j=!R&&at(t,e,n);if(!R&&!k&&!K&&!j)continue;let q=rt(e,r),Y=q-r.blockHeight;if(R&&(q-=r.waterSurfaceOffset,Y-=r.waterSurfaceOffset),Y<=0)continue;const st=u-e;let L;switch(E){case s.ORE_COAL:L=m;break;case s.ORE_COPPER:L=v;break;case s.ORE_IRON:L=M;break;case s.ORE_GOLD:L=C;break;case s.ORE_LITHIUM:L=a;break;case s.ORE_ALUMINUM:L=G;break;case s.ORE_COBALT:L=p;break;case s.STONE:L=S;break;case s.SAND:L=O;break;case s.DIRT:L=l;break;case s.WOOD:L=f;break;case s.SNOW:L=z;break;case s.DIRT_SNOW:L=g;break;case s.ICE:L=i;break;case s.GLASS:L=A;break;case s.MOON_ROCK:L=c;break;default:L=_;break}let w=1;st>0&&(w=Math.max(tt,Math.pow(B,st)));const V=r.torches||[];if(R||k){const o=$(t.tile,Y,q,!0,!1,!1,r.uvScale);o&&(R?U(I,o.positions,o.normals,o.uvs,o.indices,r.sunDirection,1,V):U(L,o.positions,o.normals,o.uvs,o.indices,r.sunDirection,w,V))}if(!R&&K){const o=$(t.tile,Y,q,!1,!0,!1,r.uvScale);if(o){const J=Math.max(tt,w*B);E===s.GRASS?U(l,o.positions,o.normals,o.uvs,o.indices,r.sunDirection,J,V):E===s.SNOW?U(g,o.positions,o.normals,o.uvs,o.indices,r.sunDirection,J,V):U(L,o.positions,o.normals,o.uvs,o.indices,r.sunDirection,J,V)}}if(!R&&j){const o=$(t.tile,Y,q,!1,!1,!0,r.uvScale);o&&(E===s.GRASS?U(h,o.positions,o.normals,o.uvs,o.indices,r.sunDirection,w,V):E===s.SNOW?U(N,o.positions,o.normals,o.uvs,o.indices,r.sunDirection,w,V):U(L,o.positions,o.normals,o.uvs,o.indices,r.sunDirection,w,V))}}}self.onmessage=t=>{const{type:n,columns:r,neighborData:_,config:l}=t.data;if(n==="buildGeometry"){const h=D(),S=D(),O=D(),f=D(),I=D(),m=D(),v=D(),M=D(),C=D(),a=D(),G=D(),p=D(),z=D(),N=D(),g=D(),i=D(),A=D(),c=D(),u=D(),e=D(),E=new Map(Object.entries(_).map(([b,d])=>[parseInt(b),d]));for(const b of r){ut(b,E,l,h,S,O,f,I,m,v,M,C,a,G,p,z,N,g,i,A,c,u,e);for(let d=0;d<b.blocks.length;d++)b.blocks[d]===s.WATER&&et(b.tile.vertices,b.tile.neighbors,b.blocks,E,d,l,v)}let R=0;for(const b of[h,S,O,f,I,m])R+=b.torchLight.filter(d=>d>0).length;(R>0||l.torches&&l.torches.length>0)&&console.log(`[GeometryWorker] Total non-zero torchLight values: ${R}`);const y={type:"geometryResult",topData:h,sideData:S,grassSideData:O,stoneData:f,sandData:I,woodData:m,waterData:v,oreCoalData:M,oreCopperData:C,oreIronData:a,oreGoldData:G,oreLithiumData:p,oreAluminumData:z,oreCobaltData:N,snowData:g,snowSideData:i,dirtSnowData:A,iceData:c,glassData:u,moonRockData:e};self.postMessage(y)}}})();
//# sourceMappingURL=geometryWorker-Bqc6d0ss.js.map
