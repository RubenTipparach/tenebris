(function(){"use strict";function Q(K,j,ce,le){let re=0;for(const X of le){const A=K-X.position.x,Y=j-X.position.y,H=ce-X.position.z,F=Math.sqrt(A*A+Y*Y+H*H);if(F<X.range){const Z=1/(1+2*F*F/(X.range*X.range));re+=Z*X.intensity}}return Math.min(re,1.5)}function ye(){return{grassPositions:[],grassNormals:[],grassUvs:[],grassSkyLight:[],grassTorchLight:[],grassIndices:[],grassVertexOffset:0,dirtPositions:[],dirtNormals:[],dirtUvs:[],dirtSkyLight:[],dirtTorchLight:[],dirtIndices:[],dirtVertexOffset:0,stonePositions:[],stoneNormals:[],stoneUvs:[],stoneSkyLight:[],stoneTorchLight:[],stoneIndices:[],stoneVertexOffset:0,sandPositions:[],sandNormals:[],sandUvs:[],sandSkyLight:[],sandTorchLight:[],sandIndices:[],sandVertexOffset:0,woodPositions:[],woodNormals:[],woodUvs:[],woodSkyLight:[],woodTorchLight:[],woodIndices:[],woodVertexOffset:0,waterPositions:[],waterNormals:[],waterUvs:[],waterIndices:[],waterVertexOffset:0,sidePositions:[],sideNormals:[],sideUvs:[],sideSkyLight:[],sideTorchLight:[],sideIndices:[],sideVertexOffset:0,waterSidePositions:[],waterSideNormals:[],waterSideUvs:[],waterSideIndices:[],waterSideVertexOffset:0,snowPositions:[],snowNormals:[],snowUvs:[],snowSkyLight:[],snowTorchLight:[],snowIndices:[],snowVertexOffset:0,icePositions:[],iceNormals:[],iceUvs:[],iceSkyLight:[],iceTorchLight:[],iceIndices:[],iceVertexOffset:0,moonRockPositions:[],moonRockNormals:[],moonRockUvs:[],moonRockSkyLight:[],moonRockTorchLight:[],moonRockIndices:[],moonRockVertexOffset:0,moonRockSidePositions:[],moonRockSideNormals:[],moonRockSideUvs:[],moonRockSideSkyLight:[],moonRockSideTorchLight:[],moonRockSideIndices:[],moonRockSideVertexOffset:0}}const l={AIR:0,STONE:1,DIRT:2,GRASS:3,WATER:4,SAND:5,WOOD:6,SNOW:15,DIRT_SNOW:16,ICE:17,GLASS:19,MOON_ROCK:22};function he(K,j){return j.radius-(j.maxDepth-1-K)*j.blockHeight}function me(K){return K.maxDepth-1-K.seaLevel}let $=null,xe=0;self.onmessage=K=>{const{type:j,tileData:ce,blockData:le,nearbyTiles:re,tileToChunk:X,config:A,torches:Y=[]}=K.data;if(j==="buildLODGeometry"){const H=new Set(re),F=new Map(Object.entries(X).map(([x,V])=>[parseInt(x),V])),Z=new Map;for(const[x,V]of Object.entries(ce)){const s=parseInt(x),a=le[s];a&&Z.set(s,{tileIndex:s,tile:V,blocks:a})}const ge=Object.keys(ce).length;if(!$||xe!==ge){$=new Map,xe=ge;for(const[x,V]of Z){const s=V.tile,a=s.vertices.length,n=Math.sqrt(s.center.x*s.center.x+s.center.y*s.center.y+s.center.z*s.center.z),f=n>0?{x:s.center.x/n,y:s.center.y/n,z:s.center.z/n}:{x:0,y:0,z:0},e=[];for(const d of s.vertices){const S=Math.sqrt(d.x*d.x+d.y*d.y+d.z*d.z);e.push(S>0?{x:d.x/S,y:d.y/S,z:d.z/S}:{x:0,y:0,z:0})}const h=[];for(let d=0;d<a;d++){const S=(d+1)%a,L=s.vertices[d],v=s.vertices[S],O=L.x+v.x,p=L.y+v.y,m=L.z+v.z,I=Math.sqrt(O*O+p*p+m*m);h.push(I>0?{x:O/I,y:p/I,z:m/I}:{x:0,y:0,z:0})}const g=[];for(let d=0;d<a;d++){const S=h[d];let L=-1,v=1/0;for(const O of s.neighbors){const p=Z.get(O);if(!p)continue;const m=p.tile.center,I=Math.sqrt(m.x*m.x+m.y*m.y+m.z*m.z);if(I===0)continue;const _=m.x/I,W=m.y/I,q=m.z/I,U=_-S.x,C=W-S.y,b=q-S.z,J=U*U+C*C+b*b;J<v&&(v=J,L=O)}g.push(L)}const i=Math.abs(f.y)<.9?{x:0,y:1,z:0}:{x:1,y:0,z:0},t=i.y*f.z-i.z*f.y,c=i.z*f.x-i.x*f.z,u=i.x*f.y-i.y*f.x,r=Math.sqrt(t*t+c*c+u*u),o=r>0?{x:t/r,y:c/r,z:u/r}:{x:1,y:0,z:0},N=f.y*o.z-f.z*o.y,w=f.z*o.x-f.x*o.z,R=f.x*o.y-f.y*o.x,z={x:N,y:w,z:R},M=[];let k=1/0,P=-1/0,y=1/0,T=-1/0;for(const d of s.vertices){const S=d.x-s.center.x,L=d.y-s.center.y,v=d.z-s.center.z,O=S*o.x+L*o.y+v*o.z,p=S*z.x+L*z.y+v*z.z;M.push({u:O,v:p}),k=Math.min(k,O),P=Math.max(P,O),y=Math.min(y,p),T=Math.max(T,p)}const D=P-k,E=T-y,G=M.map(d=>({u:(d.u-k)/D,v:(d.v-y)/E})),te={u:(0-k)/D,v:(0-y)/E};$.set(x,{normalizedCenter:f,normalizedVertices:e,edgeMidDirs:h,edgeNeighborIdx:g,normalizedUVs:G,centerUV:te})}}const se=[];for(let x=0;x<A.chunkCount;x++)se.push(ye());const Se=me(A),ue=he(Se,A)-A.lodOffset,ee=new Map;for(const[x,V]of Z){let s=0,a=l.GRASS,n=0;const f=V.blocks;for(let i=f.length-1;i>=0;i--)if(f[i]!==l.AIR&&(a===l.GRASS&&(s=i,a=f[i]),f[i]!==l.WATER)){n=i;break}const e=a===l.WATER,h=e?ue:he(s,A)-A.lodOffset,g=he(n,A)-A.lodOffset;ee.set(x,{radius:h,isWater:e,surfaceBlockType:a,terrainRadius:g})}for(const[x]of Z){if(H.has(x))continue;const V=$.get(x),s=ee.get(x),a=s.radius,n=s.surfaceBlockType,f=F.get(x)??0,e=se[f];let h,g,i,t,c,u,r;n===l.WATER?(h=e.waterPositions,g=e.waterNormals,i=e.waterUvs,t=null,c=null,u=e.waterIndices,r=e.waterVertexOffset):n===l.DIRT?(h=e.dirtPositions,g=e.dirtNormals,i=e.dirtUvs,t=e.dirtSkyLight,c=e.dirtTorchLight,u=e.dirtIndices,r=e.dirtVertexOffset):n===l.STONE?(h=e.stonePositions,g=e.stoneNormals,i=e.stoneUvs,t=e.stoneSkyLight,c=e.stoneTorchLight,u=e.stoneIndices,r=e.stoneVertexOffset):n===l.SAND?(h=e.sandPositions,g=e.sandNormals,i=e.sandUvs,t=e.sandSkyLight,c=e.sandTorchLight,u=e.sandIndices,r=e.sandVertexOffset):n===l.WOOD?(h=e.woodPositions,g=e.woodNormals,i=e.woodUvs,t=e.woodSkyLight,c=e.woodTorchLight,u=e.woodIndices,r=e.woodVertexOffset):n===l.SNOW||n===l.DIRT_SNOW?(h=e.snowPositions,g=e.snowNormals,i=e.snowUvs,t=e.snowSkyLight,c=e.snowTorchLight,u=e.snowIndices,r=e.snowVertexOffset):n===l.ICE||n===l.GLASS?(h=e.icePositions,g=e.iceNormals,i=e.iceUvs,t=e.iceSkyLight,c=e.iceTorchLight,u=e.iceIndices,r=e.iceVertexOffset):n===l.MOON_ROCK?(h=e.moonRockPositions,g=e.moonRockNormals,i=e.moonRockUvs,t=e.moonRockSkyLight,c=e.moonRockTorchLight,u=e.moonRockIndices,r=e.moonRockVertexOffset):(h=e.grassPositions,g=e.grassNormals,i=e.grassUvs,t=e.grassSkyLight,c=e.grassTorchLight,u=e.grassIndices,r=e.grassVertexOffset);const o=V.normalizedCenter,N=V.normalizedVertices,w=V.normalizedUVs,R=V.centerUV,z=r,M=o.x*a,k=o.y*a,P=o.z*a;h.push(M,k,P),g.push(o.x,o.y,o.z),i.push(R.u,R.v),t&&t.push(1),c&&c.push(Q(M,k,P,Y)),r++;for(let y=0;y<N.length;y++){const T=N[y],D=T.x*a,E=T.y*a,G=T.z*a;h.push(D,E,G),g.push(o.x,o.y,o.z),i.push(w[y].u,w[y].v),t&&t.push(1),c&&c.push(Q(D,E,G,Y)),r++,u.push(z,z+1+y,z+1+(y+1)%N.length)}n===l.WATER?e.waterVertexOffset=r:n===l.DIRT?e.dirtVertexOffset=r:n===l.STONE?e.stoneVertexOffset=r:n===l.SAND?e.sandVertexOffset=r:n===l.WOOD?e.woodVertexOffset=r:n===l.SNOW||n===l.DIRT_SNOW?e.snowVertexOffset=r:n===l.ICE||n===l.GLASS?e.iceVertexOffset=r:n===l.MOON_ROCK?e.moonRockVertexOffset=r:e.grassVertexOffset=r}for(const[x]of Z){if(H.has(x))continue;const V=$.get(x),s=ee.get(x),a=s.radius,n=s.isWater,f=s.surfaceBlockType===l.MOON_ROCK,e=V.normalizedVertices,h=V.edgeNeighborIdx,g=e.length,i=F.get(x)??0,t=se[i];for(let c=0;c<g;c++){const u=h[c];if(u<0)continue;const r=ee.get(u);if(!r)continue;const o=r.radius;if(a<=o)continue;const N=(c+1)%g,w=e[c],R=e[N],z=w.x*o,M=w.y*o,k=w.z*o,P=R.x*o,y=R.y*o,T=R.z*o,D=w.x*a,E=w.y*a,G=w.z*a,te=R.x*a,d=R.y*a,S=R.z*a,L=P-z,v=y-M,O=T-k,p=D-z,m=E-M,I=G-k,_=v*I-O*m,W=O*p-L*I,q=L*m-v*p,U=Math.sqrt(_*_+W*W+q*q),C=U>0?_/U:0,b=U>0?W/U:0,J=U>0?q/U:0;let de,ae,fe,oe,ne,ie,B;n?(de=t.waterSidePositions,ae=t.waterSideNormals,fe=t.waterSideUvs,oe=null,ne=null,ie=t.waterSideIndices,B=t.waterSideVertexOffset):f?(de=t.moonRockSidePositions,ae=t.moonRockSideNormals,fe=t.moonRockSideUvs,oe=t.moonRockSideSkyLight,ne=t.moonRockSideTorchLight,ie=t.moonRockSideIndices,B=t.moonRockSideVertexOffset):(de=t.sidePositions,ae=t.sideNormals,fe=t.sideUvs,oe=t.sideSkyLight,ne=t.sideTorchLight,ie=t.sideIndices,B=t.sideVertexOffset),de.push(z,M,k,P,y,T,te,d,S,D,E,G),ae.push(C,b,J,C,b,J,C,b,J,C,b,J),fe.push(0,0,1,0,1,1,0,1),oe&&oe.push(1,1,1,1),ne&&ne.push(Q(z,M,k,Y),Q(P,y,T,Y),Q(te,d,S,Y),Q(D,E,G,Y)),ie.push(B,B+1,B+2),ie.push(B,B+2,B+3),n?t.waterSideVertexOffset+=4:f?t.moonRockSideVertexOffset+=4:t.sideVertexOffset+=4}}for(const[x]of Z){if(H.has(x))continue;const V=$.get(x),s=ee.get(x);if(!s||!s.isWater)continue;const a=V.normalizedVertices,n=V.edgeNeighborIdx,f=a.length,e=F.get(x)??0,h=se[e];for(let g=0;g<f;g++){const i=n[g];if(i<0||!H.has(i))continue;const t=ee.get(i);if(!t)continue;const c=t.terrainRadius,u=ue;if(c>=u)continue;const r=(g+1)%f,o=a[g],N=a[r],w=o.x*c,R=o.y*c,z=o.z*c,M=N.x*c,k=N.y*c,P=N.z*c,y=o.x*u,T=o.y*u,D=o.z*u,E=N.x*u,G=N.y*u,te=N.z*u,d=M-w,S=k-R,L=P-z,v=y-w,O=T-R,p=D-z,m=S*p-L*O,I=L*v-d*p,_=d*O-S*v,W=Math.sqrt(m*m+I*I+_*_),q=W>0?m/W:0,U=W>0?I/W:0,C=W>0?_/W:0,b=h.waterSideVertexOffset;h.waterSidePositions.push(w,R,z,M,k,P,E,G,te,y,T,D),h.waterSideNormals.push(q,U,C,q,U,C,q,U,C,q,U,C),h.waterSideUvs.push(0,0,1,0,1,1,0,1),h.waterSideIndices.push(b,b+1,b+2),h.waterSideIndices.push(b,b+2,b+3),h.waterSideVertexOffset+=4}}const Ve={type:"lodGeometryResult",chunkGeometries:se};self.postMessage(Ve)}}})();
//# sourceMappingURL=lodGeometryWorker-CChbsuDK.js.map
