(function(){"use strict";var e=(t=>(t[t.AIR=0]="AIR",t[t.STONE=1]="STONE",t[t.DIRT=2]="DIRT",t[t.GRASS=3]="GRASS",t[t.WATER=4]="WATER",t[t.SAND=5]="SAND",t[t.WOOD=6]="WOOD",t[t.LEAVES=7]="LEAVES",t[t.ORE_COAL=8]="ORE_COAL",t[t.ORE_COPPER=9]="ORE_COPPER",t[t.ORE_IRON=10]="ORE_IRON",t[t.ORE_GOLD=11]="ORE_GOLD",t[t.ORE_LITHIUM=12]="ORE_LITHIUM",t[t.ORE_ALUMINUM=13]="ORE_ALUMINUM",t[t.ORE_COBALT=14]="ORE_COBALT",t))(e||{});function T(t,o,a){return{x:t,y:o,z:a}}function j(t){return{x:t.x,y:t.y,z:t.z}}function V(t,o){return{x:t.x-o.x,y:t.y-o.y,z:t.z-o.z}}function C(t,o){return{x:t.x*o,y:t.y*o,z:t.z*o}}function X(t,o){return t.x*o.x+t.y*o.y+t.z*o.z}function w(t,o){return{x:t.y*o.z-t.z*o.y,y:t.z*o.x-t.x*o.z,z:t.x*o.y-t.y*o.x}}function q(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}function W(t){const o=q(t);return o===0?{x:0,y:0,z:0}:{x:t.x/o,y:t.y/o,z:t.z/o}}function B(t){return{x:-t.x,y:-t.y,z:-t.z}}function K(t,o){return q(V(t,o))}const Y=.8,Z=.05;function H(t,o,a,k,f,x,E,l){const R=t.length,y=.001;for(let O=0;O<R;O++){const _=(O+1)%R,v=t[O],D=t[_];let r;for(const A of o){const L=k.get(A);if(!L)continue;let c=!1,$=!1;for(const Q of L.vertices)K(Q,v)<y&&(c=!0),K(Q,D)<y&&($=!0);if(c&&$){r=L;break}}if(!r||r.blocks[f]!==e.AIR)continue;let S=0;for(let A=f-1;A>=0;A--){const L=a[A];if(L!==e.AIR&&L!==e.WATER){S=A;break}}let g=0;for(let A=f-1;A>=0;A--){const L=r.blocks[A];if(L!==e.AIR&&L!==e.WATER){g=A;break}}const z=Math.max(S,g),u=x,m=E.radius-(E.maxDepth-1-z)*E.blockHeight;if(m>=u)continue;const s=W(v),b=W(D),i=C(s,u),p=C(b,u),n=C(s,m),h=C(b,m),I=V(h,n),G=V(i,n),N=W(w(I,G)),d=l.vertexOffset;l.positions.push(n.x,n.y,n.z,h.x,h.y,h.z,p.x,p.y,p.z,i.x,i.y,i.z);for(let A=0;A<4;A++)l.normals.push(N.x,N.y,N.z);l.uvs.push(0,0,1,0,1,1,0,1),l.skyLight.push(1,1,1,1),l.colors.push(1,1,1,1,1,1,1,1,1,1,1,1),l.indices.push(d,d+1,d+2,d,d+2,d+3),l.vertexOffset+=4}}function M(){return{positions:[],normals:[],uvs:[],colors:[],skyLight:[],torchLight:[],indices:[],vertexOffset:0}}function J(t,o){return o.radius-(o.maxDepth-1-t)*o.blockHeight}let P=!1;function tt(t,o,a,k){let f=0;for(const x of k){const E=t-x.position.x,l=o-x.position.y,R=a-x.position.z,y=Math.sqrt(E*E+l*l+R*R);if(y<x.range){const O=1/(1+2*y*y/(x.range*x.range));f+=O*x.intensity,P||(console.log(`[GeometryWorker] Torch light hit! vertex=(${t.toFixed(2)},${o.toFixed(2)},${a.toFixed(2)}), dist=${y.toFixed(2)}, light=${f.toFixed(3)}`),P=!0)}}return Math.min(f,1.5)}function ot(t,o,a){const k=t.blocks[o];if(k===e.AIR||k===e.WATER)return!1;for(const f of t.tile.neighbors){const x=a.get(f);if(!x)return!0;const E=x.blocks[o];if(E===void 0||E===e.AIR||E===e.WATER)return!0}return!1}function F(t,o,a,k,f,x,E,l=[]){const R=o.length/3,y=t.vertexOffset;t.positions.push.apply(t.positions,o),t.normals.push.apply(t.normals,a),t.uvs.push.apply(t.uvs,k);const O=new Array(R*3);for(let r=0;r<R;r++){const S=r*3;O[S]=1,O[S+1]=1,O[S+2]=1}t.colors.push.apply(t.colors,O);const _=new Array(R);for(let r=0;r<R;r++)_[r]=E;t.skyLight.push.apply(t.skyLight,_);const v=new Array(R);for(let r=0;r<R;r++){const S=o[r*3],g=o[r*3+1],z=o[r*3+2];v[r]=tt(S,g,z,l)}t.torchLight.push.apply(t.torchLight,v);const D=new Array(f.length);for(let r=0;r<f.length;r++)D[r]=f[r]+y;t.indices.push.apply(t.indices,D),t.vertexOffset+=R}function U(t,o,a,k,f,x,E=10){const l=t.vertices.length,R=W(t.center),y=[],O=[];for(const s of t.vertices){const b=W(s);y.push(C(b,o)),O.push(C(b,a))}const _=C(R,o),v=C(R,a),D=j(R);let r=T(1,0,0);Math.abs(X(D,r))>.9&&(r=T(0,0,1));const S=W(w(D,r));r=W(w(S,D));const g=[],z=[],u=[],m=[];if(k){const s=j(R);g.push(v.x,v.y,v.z),z.push(s.x,s.y,s.z),u.push(.5,.5);const b=.5;for(let i=0;i<l;i++){const p=O[i];g.push(p.x,p.y,p.z),z.push(s.x,s.y,s.z);const n=i/l*Math.PI*2-Math.PI/2,h=.5+Math.cos(n)*b,I=.5+Math.sin(n)*b;u.push(h,I)}for(let i=0;i<l;i++){const p=(i+1)%l;m.push(0,1+i,1+p)}}else if(f){const s=B(R);g.push(_.x,_.y,_.z),z.push(s.x,s.y,s.z),u.push(.5,.5);const b=.5;for(let i=0;i<l;i++){const p=y[i];g.push(p.x,p.y,p.z),z.push(s.x,s.y,s.z);const n=i/l*Math.PI*2-Math.PI/2,h=.5+Math.cos(n)*b,I=.5+Math.sin(n)*b;u.push(h,I)}for(let i=0;i<l;i++){const p=(i+1)%l;m.push(0,1+p,1+i)}}else if(x){let s=0;for(let b=0;b<l;b++){const i=(b+1)%l,p=O[b],n=O[i],h=y[b],I=y[i],G=V(I,h),N=V(p,h),d=W(w(G,N));g.push(h.x,h.y,h.z,I.x,I.y,I.z,n.x,n.y,n.z,p.x,p.y,p.z);for(let A=0;A<4;A++)z.push(d.x,d.y,d.z);u.push(0,0,1,0,1,1,0,1),m.push(s,s+1,s+2,s,s+2,s+3),s+=4}}return g.length===0?null:{positions:g,normals:z,uvs:u,indices:m}}function st(t,o,a,k,f,x,E,l,R,y,O,_,v,D,r,S,g){let z=0;for(let u=t.blocks.length-1;u>=0;u--)if(t.blocks[u]!==e.AIR&&t.blocks[u]!==e.WATER){z=u;break}for(let u=0;u<t.blocks.length;u++){const m=t.blocks[u];if(m===e.AIR)continue;const s=m===e.WATER,b=u>=t.blocks.length-1?e.AIR:t.blocks[u+1],i=u===0?e.AIR:t.blocks[u-1],p=b===e.AIR||!s&&b===e.WATER,n=i===e.AIR||!s&&i===e.WATER;if(s&&b!==e.AIR)continue;const h=!s&&ot(t,u,o);if(!s&&!p&&!n&&!h)continue;let I=J(u,a),G=I-a.blockHeight;if(s&&(I-=a.waterSurfaceOffset,G-=a.waterSurfaceOffset),G<=0)continue;const N=z-u;let d;switch(m){case e.ORE_COAL:d=O;break;case e.ORE_COPPER:d=_;break;case e.ORE_IRON:d=v;break;case e.ORE_GOLD:d=D;break;case e.ORE_LITHIUM:d=r;break;case e.ORE_ALUMINUM:d=S;break;case e.ORE_COBALT:d=g;break;case e.STONE:d=E;break;case e.SAND:d=l;break;case e.DIRT:d=f;break;case e.WOOD:d=R;break;default:d=k;break}let A=1;N>0&&(A=Math.max(Z,Math.pow(Y,N)));const L=a.torches||[];if(s||p){const c=U(t.tile,G,I,!0,!1,!1,a.uvScale);c&&(s?F(y,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,1,L):F(d,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,A,L))}if(!s&&n){const c=U(t.tile,G,I,!1,!0,!1,a.uvScale);if(c){const $=Math.max(Z,A*Y);m===e.GRASS?F(f,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,$,L):F(d,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,$,L)}}if(!s&&h){const c=U(t.tile,G,I,!1,!1,!0,a.uvScale);c&&(m===e.GRASS?F(x,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,A,L):F(d,c.positions,c.normals,c.uvs,c.indices,a.sunDirection,A,L))}}}self.onmessage=t=>{var x;const{type:o,columns:a,neighborData:k,config:f}=t.data;if(o==="buildGeometry"){P=!1;const E=((x=f.torches)==null?void 0:x.length)||0;if(console.log(`[GeometryWorker] Received ${E} torches`),E>0){const n=f.torches[0];console.log(`[GeometryWorker] First torch: pos=(${n.position.x.toFixed(2)}, ${n.position.y.toFixed(2)}, ${n.position.z.toFixed(2)}), range=${n.range}`)}const l=M(),R=M(),y=M(),O=M(),_=M(),v=M(),D=M(),r=M(),S=M(),g=M(),z=M(),u=M(),m=M(),s=M(),b=new Map(Object.entries(k).map(([n,h])=>[parseInt(n),h]));for(const n of a){st(n,b,f,l,R,y,O,_,v,D,r,S,g,z,u,m,s);for(let h=0;h<n.blocks.length;h++)if(n.blocks[h]===e.WATER&&(h>=n.blocks.length-1?e.AIR:n.blocks[h+1])===e.AIR){const G=J(h,f)-f.waterSurfaceOffset;H(n.tile.vertices,n.tile.neighbors,n.blocks,b,h,G,f,D)}}let i=0;for(const n of[l,R,y,O,_,v])i+=n.torchLight.filter(h=>h>0).length;(i>0||f.torches&&f.torches.length>0)&&console.log(`[GeometryWorker] Total non-zero torchLight values: ${i}`);const p={type:"geometryResult",topData:l,sideData:R,grassSideData:y,stoneData:O,sandData:_,woodData:v,waterData:D,oreCoalData:r,oreCopperData:S,oreIronData:g,oreGoldData:z,oreLithiumData:u,oreAluminumData:m,oreCobaltData:s};self.postMessage(p)}}})();
//# sourceMappingURL=geometryWorker-DEZxBUM4.js.map
