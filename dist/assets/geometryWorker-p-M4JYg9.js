(function(){"use strict";var c=(s=>(s[s.AIR=0]="AIR",s[s.STONE=1]="STONE",s[s.DIRT=2]="DIRT",s[s.GRASS=3]="GRASS",s[s.WATER=4]="WATER",s[s.SAND=5]="SAND",s[s.WOOD=6]="WOOD",s[s.LEAVES=7]="LEAVES",s))(c||{});function P(s,o,e){return{x:s,y:o,z:e}}function j(s){return{x:s.x,y:s.y,z:s.z}}function C(s,o){return{x:s.x-o.x,y:s.y-o.y,z:s.z-o.z}}function V(s,o){return{x:s.x*o,y:s.y*o,z:s.z*o}}function Z(s,o){return s.x*o.x+s.y*o.y+s.z*o.z}function F(s,o){return{x:s.y*o.z-s.z*o.y,y:s.z*o.x-s.x*o.z,z:s.x*o.y-s.y*o.x}}function w(s){return Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z)}function G(s){const o=w(s);return o===0?{x:0,y:0,z:0}:{x:s.x/o,y:s.y/o,z:s.z/o}}function $(s){return{x:-s.x,y:-s.y,z:-s.z}}function K(s,o){return w(C(s,o))}const Y=.8,q=.05;function B(s,o,e,M,p,W,I,n){const A=s.length,R=.001;for(let y=0;y<A;y++){const u=(y+1)%A,l=s[y],a=s[u];let f;for(const v of o){const L=M.get(v);if(!L)continue;let J=!1,Q=!1;for(const X of L.vertices)K(X,l)<R&&(J=!0),K(X,a)<R&&(Q=!0);if(J&&Q){f=L;break}}if(!f||f.blocks[p]!==c.AIR)continue;let z=p+1;for(let v=p+1;v<e.length;v++){const L=e[v];if(L!==c.AIR&&L!==c.WATER){z=v;break}}let k=p+1;for(let v=p+1;v<f.blocks.length;v++){const L=f.blocks[v];if(L!==c.AIR&&L!==c.WATER){k=v;break}else if(L===c.AIR)k=v+1;else break}const E=Math.min(z,k),O=W,D=I.radius-E*I.blockHeight;if(D>=O)continue;const i=G(l),x=G(a),r=V(i,O),h=V(x,O),b=V(i,D),m=V(x,D),d=C(m,b),t=C(r,b),g=G(F(d,t)),T=n.vertexOffset;n.positions.push(b.x,b.y,b.z,m.x,m.y,m.z,h.x,h.y,h.z,r.x,r.y,r.z);for(let v=0;v<4;v++)n.normals.push(g.x,g.y,g.z);n.uvs.push(0,0,1,0,1,1,0,1),n.skyLight.push(1,1,1,1),n.colors.push(1,1,1,1,1,1,1,1,1,1,1,1),n.indices.push(T,T+1,T+2,T,T+2,T+3),n.vertexOffset+=4}}function N(){return{positions:[],normals:[],uvs:[],colors:[],skyLight:[],indices:[],vertexOffset:0}}function U(s,o){return o.radius-(o.maxDepth-1-s)*o.blockHeight}function H(s,o,e){const M=s.blocks[o];if(M===c.AIR||M===c.WATER)return!1;for(const p of s.tile.neighbors){const W=e.get(p);if(!W)return!0;const I=W.blocks[o];if(I===void 0||I===c.AIR||I===c.WATER)return!0}return!1}function S(s,o,e,M,p,W,I){const n=o.length/3,A=s.vertexOffset;s.positions.push.apply(s.positions,o),s.normals.push.apply(s.normals,e),s.uvs.push.apply(s.uvs,M);const R=new Array(n*3);for(let l=0;l<n;l++){const a=l*3;R[a]=1,R[a+1]=1,R[a+2]=1}s.colors.push.apply(s.colors,R);const y=new Array(n);for(let l=0;l<n;l++)y[l]=I;s.skyLight.push.apply(s.skyLight,y);const u=new Array(p.length);for(let l=0;l<p.length;l++)u[l]=p[l]+A;s.indices.push.apply(s.indices,u),s.vertexOffset+=n}function _(s,o,e,M,p,W,I=10){const n=s.vertices.length,A=G(s.center),R=[],y=[];for(const i of s.vertices){const x=G(i);R.push(V(x,o)),y.push(V(x,e))}const u=V(A,o),l=V(A,e),a=j(A);let f=P(1,0,0);Math.abs(Z(a,f))>.9&&(f=P(0,0,1));const z=G(F(a,f));f=G(F(z,a));const k=[],E=[],O=[],D=[];if(M){const i=j(A);k.push(l.x,l.y,l.z),E.push(i.x,i.y,i.z),O.push(.5,.5);const x=.5;for(let r=0;r<n;r++){const h=y[r];k.push(h.x,h.y,h.z),E.push(i.x,i.y,i.z);const b=r/n*Math.PI*2-Math.PI/2,m=.5+Math.cos(b)*x,d=.5+Math.sin(b)*x;O.push(m,d)}for(let r=0;r<n;r++){const h=(r+1)%n;D.push(0,1+r,1+h)}}else if(p){const i=$(A);k.push(u.x,u.y,u.z),E.push(i.x,i.y,i.z),O.push(.5,.5);const x=.5;for(let r=0;r<n;r++){const h=R[r];k.push(h.x,h.y,h.z),E.push(i.x,i.y,i.z);const b=r/n*Math.PI*2-Math.PI/2,m=.5+Math.cos(b)*x,d=.5+Math.sin(b)*x;O.push(m,d)}for(let r=0;r<n;r++){const h=(r+1)%n;D.push(0,1+h,1+r)}}else if(W){let i=0;for(let x=0;x<n;x++){const r=(x+1)%n,h=y[x],b=y[r],m=R[x],d=R[r],t=C(d,m),g=C(h,m),T=G(F(t,g));k.push(m.x,m.y,m.z,d.x,d.y,d.z,b.x,b.y,b.z,h.x,h.y,h.z);for(let v=0;v<4;v++)E.push(T.x,T.y,T.z);O.push(0,0,1,0,1,1,0,1),D.push(i,i+1,i+2,i,i+2,i+3),i+=4}}return k.length===0?null:{positions:k,normals:E,uvs:O,indices:D}}function ss(s,o,e,M,p,W,I,n,A,R){let y=0;for(let u=s.blocks.length-1;u>=0;u--)if(s.blocks[u]!==c.AIR&&s.blocks[u]!==c.WATER){y=u;break}for(let u=0;u<s.blocks.length;u++){const l=s.blocks[u];if(l===c.AIR)continue;const a=l===c.WATER,f=u>=s.blocks.length-1?c.AIR:s.blocks[u+1],z=u===0?c.AIR:s.blocks[u-1],k=f===c.AIR||!a&&f===c.WATER,E=z===c.AIR||!a&&z===c.WATER;if(a&&f!==c.AIR)continue;const O=!a&&H(s,u,o);if(!a&&!k&&!E&&!O)continue;let D=U(u,e),i=D-e.blockHeight;if(a&&(D-=e.waterSurfaceOffset,i-=e.waterSurfaceOffset),i<=0)continue;const x=y-u,r=l===c.STONE,h=l===c.SAND,b=l===c.DIRT,m=l===c.WOOD;let d=1;if(x>0&&(d=Math.max(q,Math.pow(Y,x))),a||k){const t=_(s.tile,i,D,!0,!1,!1,e.uvScale);t&&(a?S(R,t.positions,t.normals,t.uvs,t.indices,e.sunDirection,1):S(r?I:h?n:b?p:m?A:M,t.positions,t.normals,t.uvs,t.indices,e.sunDirection,d))}if(!a&&E){const t=_(s.tile,i,D,!1,!0,!1,e.uvScale);if(t){const g=Math.max(q,d*Y);S(r?I:h?n:m?A:p,t.positions,t.normals,t.uvs,t.indices,e.sunDirection,g)}}if(!a&&O){const t=_(s.tile,i,D,!1,!1,!0,e.uvScale);t&&S(r?I:h?n:b?p:m?A:W,t.positions,t.normals,t.uvs,t.indices,e.sunDirection,d)}}}self.onmessage=s=>{const{type:o,columns:e,neighborData:M,config:p}=s.data;if(o==="buildGeometry"){const W=N(),I=N(),n=N(),A=N(),R=N(),y=N(),u=N(),l=new Map(Object.entries(M).map(([f,z])=>[parseInt(f),z]));for(const f of e){ss(f,l,p,W,I,n,A,R,y,u);for(let z=0;z<f.blocks.length;z++)if(f.blocks[z]===c.WATER&&(z>=f.blocks.length-1?c.AIR:f.blocks[z+1])===c.AIR){const E=U(z,p)-p.waterSurfaceOffset;B(f.tile.vertices,f.tile.neighbors,f.blocks,l,z,E,p,u)}}const a={type:"geometryResult",topData:W,sideData:I,grassSideData:n,stoneData:A,sandData:R,woodData:y,waterData:u};self.postMessage(a)}}})();
//# sourceMappingURL=geometryWorker-p-M4JYg9.js.map
