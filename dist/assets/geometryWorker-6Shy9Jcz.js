(function(){"use strict";var n=(t=>(t[t.AIR=0]="AIR",t[t.STONE=1]="STONE",t[t.DIRT=2]="DIRT",t[t.GRASS=3]="GRASS",t[t.WATER=4]="WATER",t[t.SAND=5]="SAND",t[t.WOOD=6]="WOOD",t[t.LEAVES=7]="LEAVES",t[t.ORE_COAL=8]="ORE_COAL",t[t.ORE_COPPER=9]="ORE_COPPER",t[t.ORE_IRON=10]="ORE_IRON",t[t.ORE_GOLD=11]="ORE_GOLD",t[t.ORE_LITHIUM=12]="ORE_LITHIUM",t[t.ORE_ALUMINUM=13]="ORE_ALUMINUM",t[t.ORE_COBALT=14]="ORE_COBALT",t[t.SNOW=15]="SNOW",t[t.DIRT_SNOW=16]="DIRT_SNOW",t[t.ICE=17]="ICE",t[t.FURNACE=18]="FURNACE",t[t.GLASS=19]="GLASS",t[t.COMPUTER=20]="COMPUTER",t[t.PRINTER_3D=21]="PRINTER_3D",t))(n||{});function J(t,s,r){return{x:t,y:s,z:r}}function Q(t){return{x:t.x,y:t.y,z:t.z}}function k(t,s){return{x:t.x-s.x,y:t.y-s.y,z:t.z-s.z}}function x(t,s){return{x:t.x*s,y:t.y*s,z:t.z*s}}function st(t,s){return t.x*s.x+t.y*s.y+t.z*s.z}function Y(t,s){return{x:t.y*s.z-t.z*s.y,y:t.z*s.x-t.x*s.z,z:t.x*s.y-t.y*s.x}}function T(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}function P(t){const s=T(t);return s===0?{x:0,y:0,z:0}:{x:t.x/s,y:t.y/s,z:t.z/s}}function nt(t){return{x:-t.x,y:-t.y,z:-t.z}}function X(t,s){return T(k(t,s))}const H=.8,B=.05;function ot(t,s,r,_,f,u,E){if(r[f]!==n.WATER)return;const A=t.length,d=.001;for(let S=0;S<A;S++){const I=(S+1)%A,m=t[S],M=t[I];let v;for(const y of s){const W=_.get(y);if(!W)continue;let j=!1,q=!1;for(const V of W.vertices)X(V,m)<d&&(j=!0),X(V,M)<d&&(q=!0);if(j&&q){v=W;break}}if(!v||v.blocks[f]!==n.AIR)continue;const G=(f<r.length-1?r[f+1]:n.AIR)!==n.WATER,p=u.radius-(u.maxDepth-1-f)*u.blockHeight,z=G?p-u.waterSurfaceOffset:p,C=u.radius-(u.maxDepth-f)*u.blockHeight;if(C>=z)continue;const g=P(m),c=P(M),O=x(g,z),i=x(c,z),o=x(g,C),h=x(c,C),l=k(h,o),N=k(O,o),D=P(Y(l,N)),R=E.vertexOffset;E.positions.push(o.x,o.y,o.z,h.x,h.y,h.z,i.x,i.y,i.z,O.x,O.y,O.z);for(let y=0;y<4;y++)E.normals.push(D.x,D.y,D.z);E.uvs.push(0,0,1,0,1,1,0,1),E.skyLight.push(1,1,1,1),E.colors.push(1,1,1,1,1,1,1,1,1,1,1,1),E.indices.push(R,R+1,R+2,R,R+2,R+3),E.vertexOffset+=4}}function b(){return{positions:[],normals:[],uvs:[],colors:[],skyLight:[],torchLight:[],indices:[],vertexOffset:0}}function et(t,s){return s.radius-(s.maxDepth-1-t)*s.blockHeight}function rt(t,s,r,_){let f=0;for(const u of _){const E=t-u.position.x,A=s-u.position.y,d=r-u.position.z,S=Math.sqrt(E*E+A*A+d*d);if(S<u.range){const I=1/(1+2*S*S/(u.range*u.range));f+=I*u.intensity}}return Math.min(f,1.5)}function it(t){return t===n.AIR||t===n.WATER||t===n.ICE||t===n.GLASS}function ct(t,s,r){const _=t.blocks[s];if(_===n.AIR||_===n.WATER)return!1;for(const f of t.tile.neighbors){const u=r.get(f);if(!u)return!0;const E=u.blocks[s];if(E===void 0||it(E))return!0}return!1}function U(t,s,r,_,f,u,E,A=[]){const d=s.length/3,S=t.vertexOffset;t.positions.push.apply(t.positions,s),t.normals.push.apply(t.normals,r),t.uvs.push.apply(t.uvs,_);const I=new Array(d*3);for(let a=0;a<d;a++){const G=a*3;I[G]=1,I[G+1]=1,I[G+2]=1}t.colors.push.apply(t.colors,I);const m=new Array(d);for(let a=0;a<d;a++)m[a]=E;t.skyLight.push.apply(t.skyLight,m);const M=new Array(d);for(let a=0;a<d;a++){const G=s[a*3],p=s[a*3+1],z=s[a*3+2];M[a]=rt(G,p,z,A)}t.torchLight.push.apply(t.torchLight,M);const v=new Array(f.length);for(let a=0;a<f.length;a++)v[a]=f[a]+S;t.indices.push.apply(t.indices,v),t.vertexOffset+=d}function Z(t,s,r,_,f,u,E=10){const A=t.vertices.length,d=P(t.center),S=[],I=[];for(const c of t.vertices){const O=P(c);S.push(x(O,s)),I.push(x(O,r))}const m=x(d,s),M=x(d,r),v=Q(d);let a=J(1,0,0);Math.abs(st(v,a))>.9&&(a=J(0,0,1));const G=P(Y(v,a));a=P(Y(G,v));const p=[],z=[],C=[],g=[];if(_){const c=Q(d);p.push(M.x,M.y,M.z),z.push(c.x,c.y,c.z),C.push(.5,.5);const O=.5;for(let i=0;i<A;i++){const o=I[i];p.push(o.x,o.y,o.z),z.push(c.x,c.y,c.z);const h=i/A*Math.PI*2-Math.PI/2,l=.5+Math.cos(h)*O,N=.5+Math.sin(h)*O;C.push(l,N)}for(let i=0;i<A;i++){const o=(i+1)%A;g.push(0,1+i,1+o)}}else if(f){const c=nt(d);p.push(m.x,m.y,m.z),z.push(c.x,c.y,c.z),C.push(.5,.5);const O=.5;for(let i=0;i<A;i++){const o=S[i];p.push(o.x,o.y,o.z),z.push(c.x,c.y,c.z);const h=i/A*Math.PI*2-Math.PI/2,l=.5+Math.cos(h)*O,N=.5+Math.sin(h)*O;C.push(l,N)}for(let i=0;i<A;i++){const o=(i+1)%A;g.push(0,1+o,1+i)}}else if(u){let c=0;for(let O=0;O<A;O++){const i=(O+1)%A,o=I[O],h=I[i],l=S[O],N=S[i],D=k(N,l),R=k(o,l),y=P(Y(D,R));p.push(l.x,l.y,l.z,N.x,N.y,N.z,h.x,h.y,h.z,o.x,o.y,o.z);for(let W=0;W<4;W++)z.push(y.x,y.y,y.z);C.push(0,0,1,0,1,1,0,1),g.push(c,c+1,c+2,c,c+2,c+3),c+=4}}return p.length===0?null:{positions:p,normals:z,uvs:C,indices:g}}function at(t,s,r,_,f,u,E,A,d,S,I,m,M,v,a,G,p,z,C,g,c,O){let i=0;for(let o=t.blocks.length-1;o>=0;o--)if(t.blocks[o]!==n.AIR&&t.blocks[o]!==n.WATER){i=o;break}for(let o=0;o<t.blocks.length;o++){const h=t.blocks[o];if(h===n.AIR)continue;const l=h===n.WATER,N=h===n.ICE,D=h===n.GLASS,R=o>=t.blocks.length-1?n.AIR:t.blocks[o+1],y=o===0?n.AIR:t.blocks[o-1],W=R===n.AIR||!l&&R===n.WATER||!N&&!D&&(R===n.ICE||R===n.GLASS),j=y===n.AIR||!l&&y===n.WATER||!N&&!D&&(y===n.ICE||y===n.GLASS);if(l&&R!==n.AIR&&R!==n.ICE&&R!==n.GLASS)continue;const q=!l&&ct(t,o,s);if(!l&&!W&&!j&&!q)continue;let V=et(o,r),K=V-r.blockHeight;if(l&&(V-=r.waterSurfaceOffset,K-=r.waterSurfaceOffset),K<=0)continue;const tt=i-o;let L;switch(h){case n.ORE_COAL:L=I;break;case n.ORE_COPPER:L=m;break;case n.ORE_IRON:L=M;break;case n.ORE_GOLD:L=v;break;case n.ORE_LITHIUM:L=a;break;case n.ORE_ALUMINUM:L=G;break;case n.ORE_COBALT:L=p;break;case n.STONE:L=E;break;case n.SAND:L=A;break;case n.DIRT:L=f;break;case n.WOOD:L=d;break;case n.SNOW:L=z;break;case n.DIRT_SNOW:L=g;break;case n.ICE:L=c;break;case n.GLASS:L=O;break;default:L=_;break}let F=1;tt>0&&(F=Math.max(B,Math.pow(H,tt)));const w=r.torches||[];if(l||W){const e=Z(t.tile,K,V,!0,!1,!1,r.uvScale);e&&(l?U(S,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,1,w):U(L,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,F,w))}if(!l&&j){const e=Z(t.tile,K,V,!1,!0,!1,r.uvScale);if(e){const $=Math.max(B,F*H);h===n.GRASS?U(f,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,$,w):h===n.SNOW?U(g,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,$,w):U(L,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,$,w)}}if(!l&&q){const e=Z(t.tile,K,V,!1,!1,!0,r.uvScale);e&&(h===n.GRASS?U(u,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,F,w):h===n.SNOW?U(C,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,F,w):U(L,e.positions,e.normals,e.uvs,e.indices,r.sunDirection,F,w))}}}self.onmessage=t=>{const{type:s,columns:r,neighborData:_,config:f}=t.data;if(s==="buildGeometry"){const u=b(),E=b(),A=b(),d=b(),S=b(),I=b(),m=b(),M=b(),v=b(),a=b(),G=b(),p=b(),z=b(),C=b(),g=b(),c=b(),O=b(),i=b(),o=b(),h=new Map(Object.entries(_).map(([D,R])=>[parseInt(D),R]));for(const D of r){at(D,h,f,u,E,A,d,S,I,m,M,v,a,G,p,z,C,g,c,O,i,o);for(let R=0;R<D.blocks.length;R++)D.blocks[R]===n.WATER&&ot(D.tile.vertices,D.tile.neighbors,D.blocks,h,R,f,m)}let l=0;for(const D of[u,E,A,d,S,I])l+=D.torchLight.filter(R=>R>0).length;(l>0||f.torches&&f.torches.length>0)&&console.log(`[GeometryWorker] Total non-zero torchLight values: ${l}`);const N={type:"geometryResult",topData:u,sideData:E,grassSideData:A,stoneData:d,sandData:S,woodData:I,waterData:m,oreCoalData:M,oreCopperData:v,oreIronData:a,oreGoldData:G,oreLithiumData:p,oreAluminumData:z,oreCobaltData:C,snowData:g,snowSideData:c,dirtSnowData:O,iceData:i,glassData:o};self.postMessage(N)}}})();
//# sourceMappingURL=geometryWorker-6Shy9Jcz.js.map
